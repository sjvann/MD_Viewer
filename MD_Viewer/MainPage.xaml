<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:views="clr-namespace:MD_Viewer.Views"
             xmlns:converters="clr-namespace:MD_Viewer.Converters"
             xmlns:local="clr-namespace:MD_Viewer"
             xmlns:viewmodels="clr-namespace:MD_Viewer.ViewModels"
             xmlns:models="clr-namespace:MD_Viewer.Models;assembly=MD_Viewer.Shared"
             x:Class="MD_Viewer.MainPage"
             x:DataType="viewmodels:MainViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToTextColorConverter x:Key="BoolToTextColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Grid Grid.Row="0" BackgroundColor="{StaticResource Primary}" HeightRequest="50" Padding="8,0">
            <!-- 左側：Logo 和按鈕 -->
            <HorizontalStackLayout Spacing="8" VerticalOptions="Center" HorizontalOptions="Start">
                <Label Text="MD Viewer" FontSize="18" FontAttributes="Bold" TextColor="White" VerticalOptions="Center" Margin="8,0" />
                
                <!-- 編輯/預覽切換按鈕 -->
                <Button Text="{Binding EditButtonText}" 
                        Command="{Binding ToggleEditModeCommand}"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        BorderColor="White"
                        BorderWidth="1"
                        CornerRadius="4"
                        Padding="10,4"
                        FontSize="13" />
                
                <!-- 儲存按鈕 -->
                <Button Text="儲存" 
                        Command="{Binding SaveFileCommand}"
                        IsEnabled="{Binding CanSave}"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        BorderColor="White"
                        BorderWidth="1"
                        CornerRadius="4"
                        Padding="10,4"
                        FontSize="13" />
                
                <!-- 分隔線 -->
                <BoxView WidthRequest="1" HeightRequest="24" BackgroundColor="#FFFFFF50" VerticalOptions="Center" />
                
                <!-- 匯出 PDF 按鈕 -->
                <Button Text="匯出 PDF" 
                        Clicked="OnExportPdfClicked"
                        IsEnabled="{Binding CanExport}"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        BorderColor="White"
                        BorderWidth="1"
                        CornerRadius="4"
                        Padding="10,4"
                        FontSize="13" />
                
                <!-- 匯出 HTML 按鈕 -->
                <Button Text="匯出 HTML" 
                        Clicked="OnExportHtmlClicked"
                        IsEnabled="{Binding CanExport}"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        BorderColor="White"
                        BorderWidth="1"
                        CornerRadius="4"
                        Padding="10,4"
                        FontSize="13" />
            </HorizontalStackLayout>
            
            <!-- 右側：主題選擇和訊息 -->
            <HorizontalStackLayout Spacing="12" VerticalOptions="Center" HorizontalOptions="End" Margin="0,0,16,0">
                <!-- 訊息顯示 -->
                <Label Text="{Binding SaveMessage}" TextColor="LightGreen" FontSize="12" VerticalOptions="Center" />
                <Label Text="{Binding ExportMessage}" TextColor="LightGreen" FontSize="12" VerticalOptions="Center" />
                <ActivityIndicator IsRunning="{Binding IsExporting}" Color="White" HeightRequest="20" WidthRequest="20" />
                
                <!-- 主題選擇 -->
                <Label Text="主題:" TextColor="White" FontSize="14" VerticalOptions="Center" />
                <Picker x:Name="ThemePicker"
                        SelectedIndexChanged="OnThemeChanged"
                        TextColor="White"
                        TitleColor="White"
                        BackgroundColor="#7B68EE"
                        WidthRequest="140"
                        HeightRequest="36"
                        VerticalOptions="Center">
                    <Picker.ItemsSource>
                        <x:Array Type="{x:Type x:String}">
                            <x:String>淺色</x:String>
                            <x:String>深色</x:String>
                            <x:String>One Dark Pro</x:String>
                            <x:String>Dracula</x:String>
                            <x:String>Nord</x:String>
                            <x:String>Monokai</x:String>
                            <x:String>Solarized Dark</x:String>
                            <x:String>Solarized Light</x:String>
                            <x:String>GitHub Dark</x:String>
                            <x:String>GitHub Light</x:String>
                            <x:String>護眼綠</x:String>
                            <x:String>暖色米黃</x:String>
                            <x:String>高對比</x:String>
                        </x:Array>
                    </Picker.ItemsSource>
                </Picker>
            </HorizontalStackLayout>
        </Grid>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- FileTreeView -->
            <views:FileTreeView Grid.Column="0" 
                               x:Name="FileTreeViewControl" 
                               BindingContext="{Binding FileTreeViewModel}" />

            <!-- 右側內容區域 -->
            <Grid Grid.Column="1" x:Name="PreviewContainer" BackgroundColor="White">
                
                <!-- 空狀態提示（無檔案選擇時） -->
                <Label x:Name="EmptyStateLabel"
                       Text="請選擇一個 Markdown 檔案"
                       TextColor="#666666"
                       FontSize="18"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       IsVisible="{Binding PreviewViewModel.ShowEmptyState}" />
                
                <!-- 載入中 -->
                <ActivityIndicator IsRunning="{Binding PreviewViewModel.IsLoading}"
                                   IsVisible="{Binding PreviewViewModel.IsLoading}"
                                   Color="#512BD4"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                
                <!-- 預覽模式：只顯示 WebView -->
                <WebView x:Name="PreviewWebView"
                         IsVisible="{Binding PreviewViewModel.ShowWebView}" />
                
                <!-- 編輯模式：左右分割（編輯器 + 即時預覽） -->
                <Grid IsVisible="{Binding IsEditMode}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    
                    <!-- 左側：Markdown 編輯器 -->
                    <Grid Grid.Column="0" BackgroundColor="#1e1e1e">
                        <Editor x:Name="MarkdownEditor"
                                Text="{Binding EditViewModel.MarkdownContent, Mode=TwoWay}"
                                TextColor="#d4d4d4"
                                BackgroundColor="#1e1e1e"
                                FontFamily="Consolas"
                                FontSize="14"
                                Placeholder="在此輸入 Markdown 內容..."
                                PlaceholderColor="#666666"
                                AutoSize="TextChanges"
                                IsSpellCheckEnabled="False" />
                    </Grid>
                    
                    <!-- 右側：即時預覽 -->
                    <Grid Grid.Column="1" BackgroundColor="White">
                        <WebView x:Name="EditPreviewWebView" />
                    </Grid>
                </Grid>
            </Grid>
        </Grid>
    </Grid>

</ContentPage>
