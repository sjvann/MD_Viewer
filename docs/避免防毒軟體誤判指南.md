# 避免防毒軟體誤判指南

## 問題說明

MD_Viewer.exe 被 Trend Micro Apex One 誤判為潛在勒索軟體，這是因為：
1. 程式未進行程式碼簽章（Code Signing）
2. 新編譯的程式缺少數位憑證
3. 從電子郵件下載的未簽章程式容易被標記為可疑

## 解決方案

### 方案 1：程式碼簽章（最有效）⭐

程式碼簽章是避免誤判最有效的方法。

#### 1.1 取得程式碼簽章憑證

**選項 A：購買商業憑證（推薦）**
- DigiCert、Sectigo、GlobalSign 等
- 費用：每年約 $200-500 USD
- 優點：立即生效，信譽度高

**選項 B：使用 Windows 內建工具（僅測試用）**
```powershell
# 建立自我簽章憑證（僅供測試，不適用於正式發布）
New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=MD Viewer" -CertStoreLocation Cert:\CurrentUser\My
```

#### 1.2 設定專案進行程式碼簽章

在 `MD_Viewer.csproj` 中加入：

```xml
<PropertyGroup Condition="'$(Configuration)' == 'Release'">
  <!-- 程式碼簽章設定 -->
  <SignTool>signtool</SignTool>
  <SignToolPath>C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64</SignToolPath>
  <SignToolTimestampServerUrl>http://timestamp.digicert.com</SignToolTimestampServerUrl>
  <SignToolCertificateThumbprint>YOUR_CERTIFICATE_THUMBPRINT</SignToolCertificateThumbprint>
  <SignToolCertificateFile>path\to\certificate.pfx</SignToolCertificateFile>
  <SignToolCertificatePassword>YOUR_PASSWORD</SignToolCertificatePassword>
</PropertyGroup>

<Target Name="SignOutput" AfterTargets="Publish">
  <Exec Command="&quot;$(SignToolPath)\signtool.exe&quot; sign /f &quot;$(SignToolCertificateFile)&quot; /p &quot;$(SignToolCertificatePassword)&quot; /t &quot;$(SignToolTimestampServerUrl)&quot; /v &quot;$(PublishDir)\MD_Viewer.exe&quot;" Condition="'$(Configuration)' == 'Release'" />
</Target>
```

#### 1.3 手動簽章（如果自動簽章失敗）

```powershell
# 使用 signtool 手動簽章
signtool sign /f "certificate.pfx" /p "password" /t http://timestamp.digicert.com /v "MD_Viewer.exe"
```

### 方案 2：提交誤判報告給防毒軟體廠商

#### 2.1 Trend Micro 誤判報告

1. 前往：https://www.trendmicro.com/en_us/about/legal/third-party-software-disputes.html
2. 或透過 Trend Micro Apex One 介面提交誤判報告
3. 提供以下資訊：
   - 程式名稱：MD Viewer
   - 程式用途：Markdown 檔案檢視器
   - 程式來源：自行開發
   - 檔案雜湊值（SHA256）

#### 2.2 其他防毒軟體

- **VirusTotal**：https://www.virustotal.com/gui/home/upload
- **Microsoft Defender**：透過 Windows Security 提交
- **其他廠商**：查詢各廠商官網的誤判報告頁面

### 方案 3：改善建置設定

#### 3.1 加入詳細的版本資訊

更新 `App.manifest` 加入完整的版本資訊：

```xml
<assemblyIdentity 
  version="1.0.0.0" 
  name="MD_Viewer.WinUI.app"
  processorArchitecture="*"
  type="win32" />
```

#### 3.2 使用安裝程式而非直接執行檔

使用 Inno Setup 建立的安裝程式（`MD_Viewer_Setup_v1.0.0_x64.exe`）通常比直接執行檔更不容易被誤判。

### 方案 4：暫時解決方案

#### 4.1 在 Trend Micro 中新增例外

1. 開啟 Trend Micro Apex One
2. 找到「例外清單」或「允許清單」
3. 新增以下路徑：
   - `C:\Users\User\MD Viewer\MD_Viewer.exe`
   - 或整個資料夾：`C:\Users\User\MD Viewer\`

#### 4.2 使用「允許一次」選項

在彈出的警告視窗中選擇「Allow Once」，但這只是暫時性的。

### 方案 5：改善程式發布流程

#### 5.1 使用 GitHub Releases

- 將程式發布到 GitHub Releases
- 提供完整的發布說明和雜湊值
- 防毒軟體對 GitHub 上的檔案信任度較高

#### 5.2 提供檔案雜湊值

在發布時提供：
- SHA256 雜湊值
- MD5 雜湊值
- 讓使用者可以驗證檔案完整性

#### 5.3 使用數位簽章的安裝程式

確保安裝程式本身也經過簽章。

## 立即行動建議

### 短期（立即執行）

1. ✅ 在 Trend Micro 中新增例外清單
2. ✅ 使用安裝程式而非直接執行檔
3. ✅ 在 GitHub Releases 發布時提供檔案雜湊值

### 中期（1-2 週內）

1. ⭐ 購買程式碼簽章憑證並簽章程式
2. 提交誤判報告給 Trend Micro
3. 更新建置流程以自動簽章

### 長期（持續）

1. 建立程式碼簽章的 CI/CD 流程
2. 定期更新版本資訊和憑證
3. 監控各防毒軟體的誤判情況

## 計算檔案雜湊值

```powershell
# PowerShell 計算 SHA256
Get-FileHash -Path "MD_Viewer.exe" -Algorithm SHA256

# 計算 MD5
Get-FileHash -Path "MD_Viewer.exe" -Algorithm MD5
```

## 相關資源

- [Microsoft 程式碼簽章指南](https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptography-tools)
- [.NET 程式碼簽章](https://docs.microsoft.com/en-us/dotnet/core/additional-tools/strong-name-signing)
- [Trend Micro 誤判報告](https://www.trendmicro.com/en_us/about/legal/third-party-software-disputes.html)

