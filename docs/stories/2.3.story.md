# Story 2.3: Markdown 服務實作

## Status
Done

## Story

**As a** 使用者,  
**I want** 能夠將 Markdown 內容轉換為 HTML 並進行基本驗證,  
**so that** 可以正確預覽和處理 Markdown 文件

## Acceptance Criteria

1. 成功實作 MarkdownService 的 RenderToHtml() 方法，使用 Markdig 將 Markdown 轉換為 HTML
2. 成功實作 MarkdownService 的 ValidateMarkdown() 方法，提供基本的 Markdown 格式驗證
3. 成功實作 MarkdownService 的 ExtractMetadata() 方法，從 Front Matter 提取元資料
4. 成功建立 TypeScript Markdown 渲染器（markdown-renderer.ts），整合 marked.js、highlight.js、KaTeX
5. 成功編譯 TypeScript 檔案為 JavaScript
6. 驗證 Markdig 的 MarkdownPipeline 正確設定（支援進階擴充、數學公式、語法高亮）
7. 驗證元資料提取支援 YAML Front Matter 格式
8. 專案可以成功編譯

## Tasks / Subtasks

- [x] **Task 1: 實作 MarkdownService (C#)** (AC: 1, 2, 3, 6, 7)
  - [x] 修改 `MD_Viewer/Services/MarkdownService.cs`
  - [x] 建立 MarkdownPipeline（使用 Markdig）
    - [x] 使用 `UseAdvancedExtensions()` 啟用進階擴充
    - [x] 使用 `UseMathematics()` 啟用數學公式支援
    - [x] 使用 `UseSyntaxHighlighting()` 啟用語法高亮
  - [x] 實作 RenderToHtml() 方法
    - [x] 處理空字串或 null 的情況
    - [x] 使用 Markdig.Markdown.ToHtml() 轉換
    - [x] 返回 HTML 字串
  - [x] 實作 ValidateMarkdown() 方法
    - [x] 基本驗證（檢查是否為空、基本格式檢查）
    - [x] 設定 errorMessage（如果有錯誤）
    - [x] 返回驗證結果
  - [x] 實作 ExtractMetadata() 方法
    - [x] 解析 YAML Front Matter（格式：`---\n...\n---`）
    - [x] 提取 Title、Author、Date、Tags、Description
    - [x] 返回 MarkdownMetadata 物件
    - [x] 處理沒有 Front Matter 的情況
  - [x] 加入適當的錯誤處理和日誌記錄

- [x] **Task 2: 建立 TypeScript Markdown 渲染器** (AC: 4, 5)
  - [x] 建立 `MD_Viewer.Blazor/wwwroot/js/markdown-renderer.ts`
  - [x] 安裝並匯入必要的套件
    - [x] 匯入 `marked` (^11.0.0)
    - [x] 匯入 `highlight.js` (^11.9.0)
    - [x] 匯入 `katex` (^0.16.9)
  - [x] 實作 renderMarkdown() 函數
    - [x] 設定 marked 選項（highlight 函數使用 highlight.js）
    - [x] 使用 marked.parse() 解析 Markdown
    - [x] 處理數學公式（`$$...$$` 和 `$...$`）
      - [x] 使用 KaTeX 渲染區塊公式（`$$...$$`）
      - [x] 使用 KaTeX 渲染行內公式（`$...$`）
    - [x] 返回渲染後的 HTML 字串
  - [x] 設定 TypeScript 編譯
    - [x] 驗證 tsconfig.json 設定正確
    - [x] 執行 `npm install` 安裝依賴
    - [x] 執行 `tsc` 編譯 TypeScript
    - [x] 驗證生成的 JavaScript 檔案在 `wwwroot/js/` 目錄

- [x] **Task 3: 驗證與測試** (AC: 8)
  - [x] 驗證專案可以成功編譯（C# 程式碼無 lint 錯誤）
  - [ ] 手動測試 RenderToHtml() 可以正確轉換基本 Markdown（需手動測試）
  - [ ] 手動測試 RenderToHtml() 可以處理數學公式（需手動測試）
  - [ ] 手動測試 RenderToHtml() 可以處理程式碼區塊（語法高亮）（需手動測試）
  - [ ] 手動測試 ValidateMarkdown() 可以正確驗證格式（需手動測試）
  - [ ] 手動測試 ExtractMetadata() 可以提取 Front Matter（需手動測試）
  - [ ] 手動測試 ExtractMetadata() 處理沒有 Front Matter 的情況（需手動測試）
  - [x] 驗證 TypeScript 編譯成功

## Dev Notes

### 專案結構參考
[Source: docs/v1/05_專案結構與命名規範.md#1-解決方案結構]

檔案應建立/修改於以下位置：
- Service：`MD_Viewer/Services/MarkdownService.cs`（需修改）
- TypeScript：`MD_Viewer.Blazor/wwwroot/js/markdown-renderer.ts`（需建立）
- JavaScript：`MD_Viewer.Blazor/wwwroot/js/markdown-renderer.js`（編譯後生成）

### 命名空間規範
[Source: docs/v1/05_專案結構與命名規範.md#2-命名空間規範]

- `MD_Viewer.Services` - 服務類別

### MarkdownService 實作參考
[Source: docs/v1/02_介面與類別設計.md#4-服務實作類別]

#### MarkdownPipeline 設定
```csharp
private readonly MarkdownPipeline _pipeline;

public MarkdownService()
{
    _pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseMathematics()
        .UseSyntaxHighlighting()
        .Build();
}
```

#### RenderToHtml() 實作
```csharp
public string RenderToHtml(string markdown)
{
    if (string.IsNullOrEmpty(markdown))
        return string.Empty;

    return Markdig.Markdown.ToHtml(markdown, _pipeline);
}
```

#### ValidateMarkdown() 實作
```csharp
public bool ValidateMarkdown(string markdown, out string? errorMessage)
{
    errorMessage = null;
    
    if (string.IsNullOrWhiteSpace(markdown))
    {
        errorMessage = "Markdown 內容不能為空";
        return false;
    }
    
    // 基本格式檢查（可選）
    // 例如：檢查是否有未配對的括號、標記等
    
    return true;
}
```

#### ExtractMetadata() 實作
```csharp
public MarkdownMetadata ExtractMetadata(string markdown)
{
    var metadata = new MarkdownMetadata();
    
    if (string.IsNullOrWhiteSpace(markdown))
        return metadata;
    
    // 檢查是否有 Front Matter（YAML 格式）
    if (markdown.StartsWith("---"))
    {
        var endIndex = markdown.IndexOf("---", 3);
        if (endIndex > 0)
        {
            var frontMatter = markdown.Substring(3, endIndex - 3).Trim();
            // 解析 YAML（可以使用 YamlDotNet 或簡單的字串解析）
            // 提取 Title, Author, Date, Tags, Description
        }
    }
    
    return metadata;
}
```

### TypeScript 渲染器實作參考
[Source: docs/技術分析報告.md#Markdown-渲染（混合方案）]

#### markdown-renderer.ts
```typescript
import { marked } from 'marked';
import hljs from 'highlight.js';
import katex from 'katex';

export function renderMarkdown(content: string): string {
    // 設定 marked 選項
    marked.setOptions({
        highlight: (code, lang) => {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (err) {
                    // 如果語言不支援，使用自動檢測
                }
            }
            return hljs.highlightAuto(code).value;
        }
    });
    
    // 解析 Markdown
    let html = marked.parse(content);
    
    // 處理數學公式（區塊公式：$$...$$）
    html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
        try {
            return katex.renderToString(formula.trim(), { displayMode: true });
        } catch (err) {
            return match; // 如果公式錯誤，保留原樣
        }
    });
    
    // 處理數學公式（行內公式：$...$）
    html = html.replace(/\$([^\$]+)\$/g, (match, formula) => {
        try {
            return katex.renderToString(formula.trim(), { displayMode: false });
        } catch (err) {
            return match; // 如果公式錯誤，保留原樣
        }
    });
    
    return html;
}
```

### Front Matter 格式參考

YAML Front Matter 格式範例：
```yaml
---
title: "文件標題"
author: "作者名稱"
date: 2025-01-11
tags:
  - tag1
  - tag2
description: "文件描述"
---
```

### 前一個故事的啟發
[Source: docs/stories/2.2.story.md#Dev Agent Record]

- FileTreeViewModel 已完整實作，可以正常使用
- MainViewModel 已實作檔案載入功能（LoadFileAsync）
- 檔案選擇時會觸發檔案載入，CurrentFileContent 會更新
- 注意：預覽功能尚未實作，將在後續故事中處理

### 注意事項

1. **Markdig 套件**：已在 Story 1.1 中安裝（版本 0.33.0），可以直接使用
2. **TypeScript 編譯**：需要確保 npm 依賴已安裝（已在 Story 1.1 中設定 package.json）
3. **Front Matter 解析**：可以使用簡單的字串解析，或考慮使用 YamlDotNet 套件（可選）
4. **錯誤處理**：所有方法都應包含適當的錯誤處理
5. **效能考量**：MarkdownPipeline 應作為單例重用，避免重複建立
6. **TypeScript 編譯**：確保生成的 JavaScript 檔案可以被後續的預覽功能使用

### Testing

#### 測試標準
[Source: docs/v1/05_專案結構與命名規範.md]

此故事階段需要手動測試：
- 手動驗證專案編譯成功
- 手動測試 RenderToHtml() 可以正確轉換各種 Markdown 語法
- 手動測試 ValidateMarkdown() 可以正確驗證格式
- 手動測試 ExtractMetadata() 可以提取 Front Matter
- 驗證 TypeScript 編譯成功

#### 測試檢查清單
- [ ] 專案編譯無錯誤
- [ ] RenderToHtml() 可以轉換基本 Markdown（標題、段落、列表等）
- [ ] RenderToHtml() 可以處理程式碼區塊（語法高亮）
- [ ] RenderToHtml() 可以處理數學公式
- [ ] ValidateMarkdown() 可以正確驗證格式
- [ ] ExtractMetadata() 可以提取 Front Matter
- [ ] ExtractMetadata() 處理沒有 Front Matter 的情況
- [ ] TypeScript 編譯成功

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | 初始故事建立 | Scrum Master (Bob) |
| 2025-01-11 | 1.1 | 完成所有實作任務 | Developer (James) |
| 2025-01-11 | 1.2 | QA 審查通過 | QA Agent (Alice) |
| 2025-01-11 | 1.3 | 回應 QA 建議並修正程式碼 | Developer (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- TypeScript 編譯錯誤：marked.js v11 API 變更，需要使用 `marked.use()` 和 `Renderer` 而非 `setOptions()`
- TypeScript 編譯錯誤：`renderer.code` 方法參數數量問題，已修正為正確的參數簽名
- TypeScript 編譯錯誤：`escaped` 參數類型問題，使用 `escaped ?? false` 處理 undefined
- tsconfig.json 設定：將 `moduleResolution` 從 `node` 改為 `bundler` 以支援更好的模組解析
- QA 建議修正：移除 MarkdownService 建構函式中 logger 的預設值，改為必需參數（符合 DI 最佳實踐）
- QA 建議修正：在 ValidateMarkdown() 中加入註解說明方括號檢查是簡化版本
- QA 建議修正：在 ExtractMetadata() 和 ParseYamlFrontMatter() 中加入 remarks 說明 YAML 解析限制
- QA 建議修正：在 TypeScript 行內公式正則表達式中加入註解說明瀏覽器相容性

### Completion Notes List
1. 成功實作 MarkdownService (C#)，使用 Markdig 進行 Markdown 解析
2. 實作 RenderToHtml() 方法，支援進階擴充、數學公式、語法高亮
3. 實作 ValidateMarkdown() 方法，提供基本格式驗證（檢查空內容、未配對括號、未配對程式碼區塊）
4. 實作 ExtractMetadata() 方法，支援 YAML Front Matter 解析，提取 Title、Author、Date、Tags、Description
5. 成功建立 TypeScript Markdown 渲染器（markdown-renderer.ts），整合 marked.js、highlight.js、KaTeX
6. 成功編譯 TypeScript 為 JavaScript，生成檔案位於 `MD_Viewer.Blazor/wwwroot/js/`
7. 所有 C# 程式碼通過 lint 檢查，無錯誤
8. 回應 QA 建議：修正 MarkdownService 建構函式，移除 logger 預設值，符合 DI 最佳實踐
9. 回應 QA 建議：在 ValidateMarkdown() 中加入註解說明簡化版本的驗證邏輯
10. 回應 QA 建議：在 ExtractMetadata() 和 ParseYamlFrontMatter() 中加入詳細的 remarks 說明 YAML 解析限制
11. 回應 QA 建議：在 TypeScript 行內公式正則表達式中加入註解說明瀏覽器相容性要求

### File List
**修改檔案：**
- MD_Viewer/Services/MarkdownService.cs（完整實作，包含 QA 建議修正）
- MD_Viewer.Blazor/wwwroot/tsconfig.json（調整 moduleResolution 為 bundler）
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.ts（加入瀏覽器相容性註解）

**新增檔案：**
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.ts（TypeScript 渲染器）
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.js（編譯後的 JavaScript）
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.d.ts（TypeScript 定義檔）
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.js.map（Source Map）
- MD_Viewer.Blazor/wwwroot/js/markdown-renderer.d.ts.map（定義檔 Source Map）

## QA Results

### 審查日期
2025-01-11

### 審查人員
QA Agent (Alice)

### 驗收標準審查

| AC | 描述 | 狀態 | 備註 |
|----|------|------|------|
| 1 | 成功實作 MarkdownService 的 RenderToHtml() 方法 | ✅ 通過 | 使用 Markdig 正確實作，包含錯誤處理 |
| 2 | 成功實作 MarkdownService 的 ValidateMarkdown() 方法 | ✅ 通過 | 提供基本格式驗證，包含空內容、未配對括號、未配對程式碼區塊檢查 |
| 3 | 成功實作 MarkdownService 的 ExtractMetadata() 方法 | ✅ 通過 | 支援 YAML Front Matter 解析，提取 Title、Author、Date、Tags、Description |
| 4 | 成功建立 TypeScript Markdown 渲染器 | ✅ 通過 | 整合 marked.js、highlight.js、KaTeX |
| 5 | 成功編譯 TypeScript 檔案為 JavaScript | ✅ 通過 | 編譯成功，生成檔案位於 `wwwroot/js/` |
| 6 | 驗證 Markdig 的 MarkdownPipeline 正確設定 | ✅ 通過 | 使用 UseAdvancedExtensions()、UseMathematics()、UseSyntaxHighlighting() |
| 7 | 驗證元資料提取支援 YAML Front Matter 格式 | ✅ 通過 | 支援基本 YAML Front Matter 格式 |
| 8 | 專案可以成功編譯 | ✅ 通過 | C# 程式碼無 lint 錯誤，TypeScript 編譯成功 |

### 程式碼品質審查

#### ✅ 優點

1. **架構符合性**
   - MarkdownService 正確實作 IMarkdownService 介面
   - 命名空間符合規範（MD_Viewer.Services）
   - 依賴注入設定正確（MauiProgram.cs）

2. **錯誤處理**
   - 所有公開方法都有適當的 try-catch 錯誤處理
   - 使用 ILogger 記錄錯誤
   - RenderToHtml() 在錯誤時返回空字串，避免拋出異常

3. **效能考量**
   - MarkdownPipeline 作為 readonly 欄位，在建構函式中建立一次，符合單例重用原則
   - TypeScript 渲染器使用正確的 marked.js v11 API

4. **程式碼註解**
   - 所有公開方法都有 XML 註解
   - 私有方法 ParseYamlFrontMatter 也有註解說明

5. **命名規範**
   - 類別、方法、屬性命名符合 PascalCase 規範
   - 私有欄位使用底線前綴（_pipeline, _logger）

6. **TypeScript 實作品質**
   - 正確使用 marked.js v11 的 Renderer API
   - 整合 highlight.js 進行語法高亮
   - 整合 KaTeX 進行數學公式渲染
   - 包含錯誤處理（try-catch）

#### ⚠️ 建議改進

1. **MarkdownService 建構函式**
   - **問題**：建構函式接受可選的 `ILogger<MarkdownService>? logger = null` 參數
   - **建議**：DI 容器會自動注入 logger，應移除預設值，改為 `ILogger<MarkdownService> logger`
   - **影響**：低（目前功能正常，但不符合 DI 最佳實踐）

2. **ValidateMarkdown() 驗證邏輯**
   - **問題**：方括號配對檢查過於簡單，可能產生誤報（例如：`[text](url)` 中的方括號是配對的，但檢查只計算數量）
   - **建議**：此檢查可作為基本驗證，但應在文件或註解中說明這是簡化版本
   - **影響**：低（基本驗證已足夠，複雜驗證可後續增強）

3. **ExtractMetadata() YAML 解析**
   - **問題**：使用簡化的字串解析，不支援複雜的 YAML 格式（例如：多層嵌套、多行字串等）
   - **建議**：目前實作已足夠基本需求，如需完整 YAML 支援，可考慮使用 YamlDotNet 套件
   - **影響**：低（基本 Front Matter 格式已支援）

4. **TypeScript 行內公式正則表達式**
   - **問題**：使用 `(?<!\$)\$([^\$\n]+?)\$(?!\$)` 正則表達式，包含 lookbehind assertion，可能不支援所有舊版瀏覽器
   - **建議**：此正則表達式在現代瀏覽器中應可正常運作，但應在文件或註解中說明瀏覽器相容性要求
   - **影響**：低（現代瀏覽器都支援）

5. **錯誤處理一致性**
   - **問題**：RenderToHtml() 在錯誤時返回空字串，而 ValidateMarkdown() 和 ExtractMetadata() 在錯誤時仍返回部分結果
   - **建議**：錯誤處理策略一致，目前實作可接受
   - **影響**：無（不同方法有不同的錯誤處理策略是合理的）

### 測試建議

#### 手動測試項目（待執行）

1. **RenderToHtml() 測試**
   - [ ] 測試基本 Markdown 語法（標題、段落、列表、連結、圖片）
   - [ ] 測試程式碼區塊（含語法高亮）
   - [ ] 測試數學公式（區塊公式 `$$...$$` 和行內公式 `$...$`）
   - [ ] 測試空字串和 null 輸入
   - [ ] 測試大型 Markdown 檔案（效能測試）

2. **ValidateMarkdown() 測試**
   - [ ] 測試空字串驗證
   - [ ] 測試未配對方括號的情況
   - [ ] 測試未配對程式碼區塊標記的情況
   - [ ] 測試正常 Markdown 內容驗證

3. **ExtractMetadata() 測試**
   - [ ] 測試包含 Front Matter 的 Markdown 檔案
   - [ ] 測試不包含 Front Matter 的 Markdown 檔案
   - [ ] 測試各種 Front Matter 格式（單行 tags、多行 tags、日期格式等）
   - [ ] 測試邊界情況（空 Front Matter、格式錯誤的 Front Matter）

4. **TypeScript 渲染器測試**
   - [ ] 測試在瀏覽器中載入並執行 renderMarkdown() 函數
   - [ ] 測試語法高亮功能
   - [ ] 測試數學公式渲染功能
   - [ ] 測試錯誤處理（無效的 Markdown、無效的數學公式等）

### 審查結論

**整體評估**：✅ **通過審查**

**總結**：
- 所有驗收標準均已達成
- 程式碼品質良好，符合架構設計和命名規範
- 錯誤處理適當，有日誌記錄
- TypeScript 渲染器正確實作，編譯成功
- 建議改進項目均為非關鍵性問題，不影響功能運作

**建議**：
1. 可考慮修正 MarkdownService 建構函式的 logger 參數（移除預設值）
2. 建議進行手動測試以驗證功能運作正常
3. 如需更完整的 YAML 支援，可考慮在後續故事中整合 YamlDotNet 套件

**狀態更新**：✅ **Done**（待手動測試完成後可標記為完全完成）

