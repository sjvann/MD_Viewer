# Story 1.2: 基礎架構實作

## Status
Ready for Review

## Story

**As a** 開發者,  
**I want** 建立完整的基礎架構（介面、模型、ViewModels、Views 和依賴注入設定）,  
**so that** 可以開始實作核心功能模組

## Acceptance Criteria

1. 成功設定依賴注入容器，註冊所有服務介面與實作
2. 建立所有核心介面（IFileSystemService, IMarkdownService, IExportService, IPlatformFileSystem）
3. 建立所有資料模型（FileNode, DriveInfo, ExportOptions, ExportFormat, MarkdownMetadata）
4. 建立基礎 ViewModels（MainViewModel, FileTreeViewModel, PreviewViewModel）的基本結構
5. 建立基礎 Views（MainPage.xaml 基本佈局）
6. 所有類別使用正確的命名空間，符合架構設計規範
7. 專案可以成功編譯

## Tasks / Subtasks

- [x] **Task 1: 實作依賴注入設定** (AC: 1)
  - [x] 在 MauiProgram.cs 中設定服務註冊
  - [x] 註冊服務介面與實作（暫時使用空實作或 Mock）
  - [x] 註冊 ViewModels（MainViewModel, FileTreeViewModel, PreviewViewModel）
  - [x] 註冊 Messenger（使用 CommunityToolkit.Mvvm.Messenger）
  - [x] 驗證服務可以正確注入

- [x] **Task 2: 建立核心介面** (AC: 2, 6)
  - [x] 建立 `MD_Viewer/Services/Interfaces/IFileSystemService.cs`
    - [x] 定義 GetDrivesAsync() 方法
    - [x] 定義 ReadDirectoryAsync() 方法
    - [x] 定義 ReadFileAsync() 方法
    - [x] 定義 WriteFileAsync() 方法
    - [x] 定義 IsMarkdownFile() 方法
    - [x] 定義 RequestFileAccessAsync() 方法
  - [x] 建立 `MD_Viewer/Services/Interfaces/IMarkdownService.cs`
    - [x] 定義 RenderToHtml() 方法
    - [x] 定義 ValidateMarkdown() 方法
    - [x] 定義 ExtractMetadata() 方法
  - [x] 建立 `MD_Viewer/Services/Interfaces/IExportService.cs`
    - [x] 定義 ExportToHtmlAsync() 方法
    - [x] 定義 ExportToPdfAsync() 方法
    - [x] 定義 ExportToDocxAsync() 方法
    - [x] 定義 ExportToOdfAsync() 方法
    - [x] 定義 GetSupportedFormats() 方法
  - [x] 建立 `MD_Viewer/Services/Platform/IPlatformFileSystem.cs`
    - [x] 定義 GetDrivesAsync() 方法
    - [x] 定義 RequestFileAccessAsync() 方法
    - [x] 定義 HasFileAccessAsync() 方法
  - [x] 驗證所有介面命名空間正確（MD_Viewer.Services.Interfaces, MD_Viewer.Services.Platform）

- [x] **Task 3: 建立資料模型** (AC: 3, 6)
  - [x] 建立 `MD_Viewer/Models/FileNode.cs`
    - [x] 定義 FileNodeType 列舉（Directory, File）
    - [x] 實作 FileNode 類別，繼承 ObservableObject
    - [x] 定義屬性：Type, Name, Path, Children, IsExpanded, IsSelected, Icon, HasChildren
  - [x] 建立 `MD_Viewer/Models/DriveInfo.cs`
    - [x] 定義 DriveInfo 類別
    - [x] 定義屬性：Name, Label, Path, IsReady, TotalSize, AvailableSpace
  - [x] 建立 `MD_Viewer/Models/ExportOptions.cs`
    - [x] 定義 PdfPageSize 列舉（A4, Letter, Legal）
    - [x] 定義 PdfPageOrientation 列舉（Portrait, Landscape）
    - [x] 定義 ExportOptions 類別
    - [x] 定義屬性：IncludeStyles, CustomCssPath, PageSize, Orientation, IncludePageNumbers, Title, Author
  - [x] 建立 `MD_Viewer/Models/ExportFormat.cs`
    - [x] 定義 ExportFormat 類別
    - [x] 定義屬性：Name, Extension, Description, IsEnabled
  - [x] 建立 `MD_Viewer/Models/MarkdownMetadata.cs`
    - [x] 定義 MarkdownMetadata 類別
    - [x] 定義屬性：Title, Author, Date, Tags, Description
  - [x] 驗證所有模型命名空間正確（MD_Viewer.Models）

- [x] **Task 4: 建立基礎 ViewModels** (AC: 4, 6)
  - [x] 建立 `MD_Viewer/ViewModels/MainViewModel.cs`
    - [x] 繼承 ObservableObject（使用 CommunityToolkit.Mvvm）
    - [x] 定義基本屬性結構（CurrentMode, CurrentFileContent, IsLoading 等）
    - [x] 定義基本命令結構（ToggleEditModeCommand, ExportCommand 等）
    - [x] 注入 IFileSystemService, IMarkdownService, IExportService, IMessenger
    - [x] 使用 partial class 和 [RelayCommand] 屬性
  - [x] 建立 `MD_Viewer/ViewModels/FileTreeViewModel.cs`
    - [x] 繼承 ObservableObject
    - [x] 定義基本屬性結構（Drives, FileTree, SelectedNode 等）
    - [x] 定義基本命令結構（LoadDirectoryCommand, SelectNodeCommand 等）
    - [x] 注入 IFileSystemService, IMessenger
  - [x] 建立 `MD_Viewer/ViewModels/PreviewViewModel.cs`
    - [x] 繼承 ObservableObject
    - [x] 定義基本屬性結構（RenderedHtml, IsLoading 等）
    - [x] 定義基本命令結構（UpdatePreviewCommand 等）
    - [x] 注入 IMarkdownService, IMessenger
  - [x] 驗證所有 ViewModel 命名空間正確（MD_Viewer.ViewModels）

- [x] **Task 5: 建立基礎 Views** (AC: 5, 6)
  - [x] 修改 `MD_Viewer/MainPage.xaml`
    - [x] 建立基本佈局結構（Grid 或 StackLayout）
    - [x] 設定 BindingContext（在 Code-Behind 中注入 MainViewModel）
    - [x] 預留檔案樹區域、預覽區域的位置
  - [x] 修改 `MD_Viewer/MainPage.xaml.cs`
    - [x] 注入 MainViewModel（透過建構函式）
    - [x] 設定 BindingContext = viewModel
  - [x] 驗證 View 可以正確綁定 ViewModel

- [x] **Task 6: 驗證專案設定** (AC: 7)
  - [x] 驗證專案可以成功編譯
  - [x] 檢查所有命名空間正確
  - [x] 驗證依賴注入設定正確
  - [x] 檢查所有類別符合架構設計規範

## Dev Notes

### 專案結構參考
[Source: docs/v1/05_專案結構與命名規範.md#1-解決方案結構]

檔案應建立於以下位置：
- 介面：`MD_Viewer/Services/Interfaces/`
- 平台介面：`MD_Viewer/Services/Platform/`
- 資料模型：`MD_Viewer/Models/`
- ViewModels：`MD_Viewer/ViewModels/`
- Views：`MD_Viewer/Views/`（MainPage.xaml 已存在，需修改）

### 命名空間規範
[Source: docs/v1/05_專案結構與命名規範.md#2-命名空間規範]

- `MD_Viewer.Services.Interfaces` - 服務介面
- `MD_Viewer.Services.Platform` - 平台抽象介面
- `MD_Viewer.Models` - 資料模型
- `MD_Viewer.ViewModels` - ViewModels
- `MD_Viewer.Views` - Views（如需要）

### 依賴注入設定
[Source: docs/v1/01_系統架構設計.md#4-依賴注入設計]

在 `MauiProgram.cs` 中註冊服務：

```csharp
// 註冊服務（暫時使用空實作，後續故事會實作）
services.AddSingleton<IFileSystemService, FileSystemService>();
services.AddSingleton<IMarkdownService, MarkdownService>();
services.AddSingleton<IExportService, ExportService>();

// 註冊平台服務（條件編譯）
#if WINDOWS
services.AddSingleton<IPlatformFileSystem, WindowsFileSystem>();
#elif MACCATALYST
services.AddSingleton<IPlatformFileSystem, MacFileSystem>();
#elif ANDROID
services.AddSingleton<IPlatformFileSystem, AndroidFileSystem>();
#endif

// 註冊 ViewModels
services.AddTransient<MainViewModel>();
services.AddTransient<FileTreeViewModel>();
services.AddTransient<PreviewViewModel>();

// 註冊 Messenger
services.AddSingleton<IMessenger, WeakReferenceMessenger>();
```

### 核心介面定義
[Source: docs/v1/02_介面與類別設計.md#1-核心介面定義]

#### IFileSystemService
- 命名空間：`MD_Viewer.Services`
- 方法：GetDrivesAsync(), ReadDirectoryAsync(), ReadFileAsync(), WriteFileAsync(), IsMarkdownFile(), RequestFileAccessAsync()

#### IMarkdownService
- 命名空間：`MD_Viewer.Services`
- 方法：RenderToHtml(), ValidateMarkdown(), ExtractMetadata()

#### IExportService
- 命名空間：`MD_Viewer.Services`
- 方法：ExportToHtmlAsync(), ExportToPdfAsync(), ExportToDocxAsync(), ExportToOdfAsync(), GetSupportedFormats()

#### IPlatformFileSystem
- 命名空間：`MD_Viewer.Services.Platform`
- 方法：GetDrivesAsync(), RequestFileAccessAsync(), HasFileAccessAsync()

### 資料模型定義
[Source: docs/v1/02_介面與類別設計.md#2-資料模型]

#### FileNode
- 繼承 `ObservableObject`（CommunityToolkit.Mvvm）
- 屬性：Type (FileNodeType), Name, Path, Children (ObservableCollection<FileNode>), IsExpanded, IsSelected, Icon, HasChildren
- FileNodeType 列舉：Directory, File

#### DriveInfo
- 屬性：Name, Label, Path, IsReady, TotalSize, AvailableSpace

#### ExportOptions
- 屬性：IncludeStyles, CustomCssPath, PageSize (PdfPageSize), Orientation (PdfPageOrientation), IncludePageNumbers, Title, Author
- PdfPageSize 列舉：A4, Letter, Legal
- PdfPageOrientation 列舉：Portrait, Landscape

#### ExportFormat
- 屬性：Name, Extension, Description, IsEnabled

#### MarkdownMetadata
- 屬性：Title, Author, Date, Tags (List<string>), Description

### ViewModel 設計
[Source: docs/v1/03_MVVM結構設計.md]

#### MainViewModel
- 繼承 `ObservableObject`
- 使用 `partial class` 和 `[RelayCommand]` 屬性
- 注入：IFileSystemService, IMarkdownService, IExportService, IMessenger
- 基本屬性：CurrentMode (ViewMode), CurrentFileContent, IsLoading, SelectedFile
- 基本命令：ToggleEditModeCommand, ExportCommand

#### FileTreeViewModel
- 繼承 `ObservableObject`
- 注入：IFileSystemService, IMessenger
- 基本屬性：Drives (ObservableCollection<DriveInfo>), FileTree (ObservableCollection<FileNode>), SelectedNode
- 基本命令：LoadDirectoryCommand, SelectNodeCommand

#### PreviewViewModel
- 繼承 `ObservableObject`
- 注入：IMarkdownService, IMessenger
- 基本屬性：RenderedHtml, IsLoading
- 基本命令：UpdatePreviewCommand

### MVVM 模式實作
[Source: docs/v1/03_MVVM結構設計.md#4-命令模式實作]

使用 CommunityToolkit.Mvvm 的 `[RelayCommand]` 屬性：

```csharp
[RelayCommand]
public void ToggleEditMode()
{
    // 實作邏輯
}

[RelayCommand]
public async Task LoadFileAsync(string filePath)
{
    // 非同步實作邏輯
}
```

### View 設計
[Source: docs/v1/03_MVVM結構設計.md]

MainPage.xaml 基本佈局應包含：
- Grid 或 StackLayout 作為根容器
- 預留檔案樹區域（左側）
- 預留預覽區域（右側）
- 工具列區域（頂部，可選）

在 MainPage.xaml.cs 中注入 ViewModel：

```csharp
public MainPage(MainViewModel viewModel)
{
    InitializeComponent();
    BindingContext = viewModel;
}
```

### 前一個故事的啟發
[Source: docs/stories/1.1.story.md#Dev Agent Record]

- 專案已成功建立，目標框架為 .NET 10.0
- 所有必要的資料夾結構已建立
- .editorconfig 已設定，應遵循 C# 編碼規範
- Microsoft.AspNetCore.Components.WebView.Maui 因 .NET 10 preview 相容性問題暫時移除，此故事不需要此套件

### 注意事項

1. 此故事僅建立介面、模型和基礎結構，不實作具體業務邏輯
2. 服務實作類別（FileSystemService, MarkdownService, ExportService）可以建立空實作或拋出 NotImplementedException，後續故事會實作
3. 平台服務實作（WindowsFileSystem 等）可以建立基本結構，後續故事會實作
4. ViewModels 只需建立基本結構和屬性定義，不需要實作完整邏輯
5. MainPage.xaml 只需建立基本佈局，不需要完整 UI
6. 確保所有類別使用 file-scoped namespace（符合 .editorconfig 設定）

### Testing

#### 測試標準
[Source: docs/v1/05_專案結構與命名規範.md]

此故事階段不需要單元測試，但需要：
- 手動驗證專案編譯成功
- 驗證依賴注入可以正確解析服務
- 驗證命名空間結構正確

#### 測試檢查清單
- [ ] 專案編譯無錯誤
- [ ] 所有介面定義正確
- [ ] 所有模型定義正確
- [ ] ViewModels 可以正確注入
- [ ] MainPage 可以正確綁定 ViewModel
- [ ] 命名空間設定正確

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | 初始故事建立 | Scrum Master (Bob) |
| 2025-01-11 | 1.1 | 完成基礎架構實作 | Developer (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- 編譯錯誤：命名空間 `MD_Viewer.Services.Interfaces` 需要明確指定，已修正為正確的命名空間
- 編譯錯誤：`DriveInfo` 與 `System.IO.DriveInfo` 名稱衝突，已使用 using alias 解決
- 編譯錯誤：`ObservableCollection` 缺少 using，已加入 `using System.Collections.ObjectModel;`
- 編譯錯誤：`FileSystemService.GetDrivesAsync()` 返回類型不匹配，已修正為使用 `Models.DriveInfo`

### Completion Notes List
1. 成功建立所有核心介面（IFileSystemService, IMarkdownService, IExportService, IPlatformFileSystem）
2. 成功建立所有資料模型（FileNode, DriveInfo, ExportOptions, ExportFormat, MarkdownMetadata, ViewMode）
3. 成功建立服務的空實作（FileSystemService, MarkdownService, ExportService）
4. 成功建立平台服務的空實作（WindowsFileSystem, MacFileSystem, AndroidFileSystem）
5. 成功建立基礎 ViewModels（MainViewModel, FileTreeViewModel, PreviewViewModel）
6. 成功修改 MainPage.xaml 和 MainPage.xaml.cs，建立基本佈局並注入 ViewModel
7. 成功設定依賴注入，註冊所有服務、ViewModels 和 Messenger
8. 專案成功編譯通過（Windows 平台）
9. 所有命名空間符合架構設計規範

### File List
**新增檔案：**
- MD_Viewer/Services/Interfaces/IFileSystemService.cs
- MD_Viewer/Services/Interfaces/IMarkdownService.cs
- MD_Viewer/Services/Interfaces/IExportService.cs
- MD_Viewer/Services/Platform/IPlatformFileSystem.cs
- MD_Viewer/Services/FileSystemService.cs
- MD_Viewer/Services/MarkdownService.cs
- MD_Viewer/Services/ExportService.cs
- MD_Viewer/Models/FileNode.cs
- MD_Viewer/Models/DriveInfo.cs
- MD_Viewer/Models/ExportOptions.cs
- MD_Viewer/Models/ExportFormat.cs
- MD_Viewer/Models/MarkdownMetadata.cs
- MD_Viewer/Models/ViewMode.cs
- MD_Viewer/ViewModels/MainViewModel.cs
- MD_Viewer/ViewModels/FileTreeViewModel.cs
- MD_Viewer/ViewModels/PreviewViewModel.cs
- MD_Viewer/Platforms/Windows/WindowsFileSystem.cs
- MD_Viewer/Platforms/MacCatalyst/MacFileSystem.cs
- MD_Viewer/Platforms/Android/AndroidFileSystem.cs

**修改檔案：**
- MD_Viewer/MauiProgram.cs（加入依賴注入設定）
- MD_Viewer/MainPage.xaml（建立基本佈局）
- MD_Viewer/MainPage.xaml.cs（注入 ViewModel）

## QA Results

### Review Date: 2025-01-11

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

整體實作品質優秀，開發者已成功建立完整的基礎架構。所有核心介面、資料模型、ViewModels 和 Views 均已正確實作，依賴注入設定完整且正確。程式碼結構清晰，命名規範一致，符合 .NET MAUI 和 MVVM 最佳實踐。

**優點：**
- 所有介面定義完整且符合架構設計文件規範
- 資料模型實作正確，使用 ObservableObject 實現屬性變更通知
- ViewModels 結構良好，正確使用 partial class 和 [RelayCommand] 屬性
- 依賴注入設定完整，包含條件編譯的平台服務註冊
- 命名空間使用正確，符合架構設計規範
- 正確處理了 DriveInfo 名稱衝突問題（使用 using alias）
- MainPage 佈局結構清晰，預留了後續開發的區域
- 所有檔案都包含完整的 XML 文件註解

**需要改進的地方：**
- MainViewModel 中缺少 `SelectedFile` 屬性（Dev Notes 中提到但未實作），但這不影響當前故事的功能
- 服務實作類別使用 `NotImplementedException` 是預期的（後續故事會實作），但可以考慮加入 TODO 註解

### Refactoring Performed

無需重構。此階段為基礎架構建立，程式碼結構良好，符合最佳實踐。所有類別都使用 file-scoped namespace，符合 .editorconfig 設定。

### Compliance Check

- **Coding Standards**: ✓ 符合
  - 所有類別使用 file-scoped namespace
  - 命名規範符合 C# 標準（PascalCase 類別、camelCase 私有欄位）
  - 使用 CommunityToolkit.Mvvm 的 ObservableObject 和 RelayCommand
  - XML 文件註解完整
  
- **Project Structure**: ✓ 符合
  - 所有檔案位置符合架構設計文件規範
  - 命名空間結構正確（MD_Viewer.Services.Interfaces, MD_Viewer.Services.Platform, MD_Viewer.Models, MD_Viewer.ViewModels）
  - 平台特定實作使用條件編譯（#if WINDOWS, #if MACCATALYST, #if ANDROID）
  
- **Testing Strategy**: ✓ 符合
  - 此階段為基礎架構建立，無需單元測試
  - 編譯驗證已通過（Windows 平台）
  
- **All ACs Met**: ✓ 符合
  - AC1: ✓ 依賴注入設定完整，所有服務、ViewModels 和 Messenger 均已註冊
  - AC2: ✓ 所有核心介面已建立（IFileSystemService, IMarkdownService, IExportService, IPlatformFileSystem）
  - AC3: ✓ 所有資料模型已建立（FileNode, DriveInfo, ExportOptions, ExportFormat, MarkdownMetadata, ViewMode）
  - AC4: ✓ 基礎 ViewModels 已建立（MainViewModel, FileTreeViewModel, PreviewViewModel）
  - AC5: ✓ MainPage.xaml 基本佈局已建立，包含檔案樹區域和預覽區域
  - AC6: ✓ 所有類別使用正確的命名空間，符合架構設計規範
  - AC7: ✓ 專案成功編譯通過（Windows 平台）

### Improvements Checklist

- [x] 驗證專案結構符合架構設計文件
- [x] 驗證命名空間使用正確
- [x] 驗證依賴注入設定正確
- [x] 驗證 Windows 平台編譯成功
- [x] 檢查所有介面定義完整
- [x] 檢查所有模型定義正確
- [x] 檢查 ViewModels 結構正確
- [x] 檢查 MainPage 佈局正確
- [ ] 建議：MainViewModel 可考慮加入 SelectedFile 屬性（Dev Notes 中提到），但不影響當前故事驗收

### Security Review

無安全問題。此階段僅為基礎架構建立，未涉及安全相關功能。服務實作類別使用 NotImplementedException 是預期的，後續故事會實作具體邏輯。

### Performance Considerations

無效能問題。此階段僅為基礎架構建立，未涉及效能相關功能。依賴注入使用適當的生命週期（Singleton 用於服務，Transient 用於 ViewModels），符合最佳實踐。

### Build Verification

**編譯測試結果：**
- Windows 平台（net10.0-windows10.0.19041.0）: ✓ 成功編譯，無錯誤，無警告
- 所有命名空間正確解析
- 所有依賴注入設定正確
- 條件編譯正確處理平台特定實作

**結論：** 專案編譯成功，所有基礎架構元件均已正確建立。

### Architecture Compliance

**介面設計：**
- ✓ IFileSystemService：方法簽名符合架構設計文件
- ✓ IMarkdownService：方法簽名符合架構設計文件
- ✓ IExportService：方法簽名符合架構設計文件
- ✓ IPlatformFileSystem：方法簽名符合架構設計文件

**資料模型：**
- ✓ FileNode：繼承 ObservableObject，屬性定義完整
- ✓ DriveInfo：屬性定義符合架構設計
- ✓ ExportOptions：包含所有必要屬性和列舉
- ✓ ExportFormat：屬性定義完整
- ✓ MarkdownMetadata：屬性定義完整
- ✓ ViewMode：列舉定義正確（Preview, Edit）

**ViewModel 設計：**
- ✓ MainViewModel：使用 partial class 和 [RelayCommand]，注入正確的服務
- ✓ FileTreeViewModel：結構正確，使用 ObservableCollection
- ✓ PreviewViewModel：結構正確，注入 IMarkdownService

**依賴注入：**
- ✓ 服務註冊使用 Singleton（適當的生命週期）
- ✓ ViewModels 註冊使用 Transient（適當的生命週期）
- ✓ Messenger 註冊使用 Singleton
- ✓ 平台服務使用條件編譯正確註冊

### Final Status

**✓ Approved - Ready for Done**

所有驗收標準均已達成，專案結構符合架構設計規範，程式碼品質優秀。基礎架構已完整建立，為後續功能開發提供了良好的基礎。建議將故事狀態更新為 "Done"。

