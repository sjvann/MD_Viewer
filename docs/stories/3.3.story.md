# Story 3.3: PDF 匯出功能實作

## Status
Draft

## Story

**As a** 使用者,  
**I want** 能夠將 Markdown 文件匯出為 PDF 格式,  
**so that** 可以產生可列印的文件或分享給其他人

## Acceptance Criteria

1. 可以從匯出選單選擇 PDF 格式
2. 匯出時顯示檔案儲存對話框，讓使用者選擇儲存位置和檔名
3. 匯出的 PDF 檔案包含完整的 Markdown 渲染內容
4. 匯出的 PDF 檔案支援頁面大小設定（A4、Letter、Legal）
5. 匯出的 PDF 檔案支援頁面方向設定（直向、橫向）
6. 匯出的 PDF 檔案可以選擇是否包含頁碼
7. 匯出成功後顯示成功訊息
8. 匯出失敗時顯示錯誤訊息
9. 匯出過程中顯示載入狀態
10. 匯出的 PDF 檔案可以在 PDF 閱讀器中正常開啟和顯示

## Tasks / Subtasks

- [ ] **Task 1: 安裝與設定 QuestPDF** (AC: 3, 4, 5, 6)
  - [ ] 在 `MD_Viewer/MD_Viewer.csproj` 中加入 QuestPDF NuGet 套件參考
  - [ ] 確認 QuestPDF 版本與 .NET 10 相容性
  - [ ] 學習 QuestPDF API 基本用法（Document.Create, Page, Container 等）

- [ ] **Task 2: 實作 ExportService.ExportToPdfAsync()** (AC: 3, 4, 5, 6)
  - [ ] 修改 `MD_Viewer/Services/ExportService.cs`
  - [ ] 實作 `ExportToPdfAsync()` 方法
  - [ ] 使用 `IMarkdownService.RenderToHtml()` 將 Markdown 轉換為 HTML
  - [ ] 將 HTML 內容轉換為 QuestPDF Document
  - [ ] 處理 ExportOptions（PageSize, Orientation, IncludePageNumbers, Title, Author）
  - [ ] 實作 HTML 到 QuestPDF 元素的轉換邏輯
  - [ ] 處理基本 Markdown 元素（標題、段落、列表、程式碼區塊、表格等）
  - [ ] 使用 `IFileSystemService.WriteFileAsync()` 或直接寫入 PDF 檔案
  - [ ] 加入錯誤處理和日誌記錄

- [ ] **Task 3: 實作 PDF 樣式與格式** (AC: 4, 5, 6)
  - [ ] 實作頁面大小設定（A4、Letter、Legal）
  - [ ] 實作頁面方向設定（直向、橫向）
  - [ ] 實作頁碼功能（如果 IncludePageNumbers 為 true）
  - [ ] 實作標題樣式（h1-h6）
  - [ ] 實作程式碼區塊樣式
  - [ ] 實作表格樣式
  - [ ] 實作分頁處理（避免內容被截斷）

- [ ] **Task 4: 整合 PDF 匯出功能到 MainViewModel** (AC: 1, 7, 8, 9)
  - [ ] 修改 `MD_Viewer/ViewModels/MainViewModel.cs`
  - [ ] 在 `ExportAsync()` 方法中加入 PDF 格式處理邏輯
  - [ ] 使用 `IExportService.ExportToPdfAsync()` 執行匯出
  - [ ] 處理匯出成功和失敗情況
  - [ ] 更新 `SupportedExportFormats` 中 PDF 格式的 `IsEnabled` 為 `true`（透過 ExportService.GetSupportedFormats()）

- [ ] **Task 5: 測試與驗證** (AC: 10)
  - [ ] 測試 PDF 匯出功能
  - [ ] 驗證匯出的 PDF 檔案可以在 PDF 閱讀器中正常開啟
  - [ ] 驗證 PDF 內容與預覽一致
  - [ ] 測試不同頁面大小和方向
  - [ ] 測試頁碼功能
  - [ ] 測試各種 Markdown 元素（標題、列表、程式碼、表格等）
  - [ ] 測試錯誤處理（權限不足、磁碟空間不足等）
  - [ ] 測試使用者取消操作

## Dev Notes

### 專案結構參考
[Source: docs/v1/05_專案結構與命名規範.md#1-解決方案結構]

檔案應建立於以下位置：
- ExportService 修改：`MD_Viewer/Services/ExportService.cs`
- MainViewModel 修改：`MD_Viewer/ViewModels/MainViewModel.cs`

**注意**：根據專案結構，可以考慮建立 `MD_Viewer/Services/Export/PdfExporter.cs` 作為獨立的 PDF 匯出器類別，但目前先實作在 `ExportService` 中，後續可重構。

### 命名空間規範
[Source: docs/v1/05_專案結構與命名規範.md#2-命名空間規範]

- `MD_Viewer.Services` - 服務類別
- `MD_Viewer.ViewModels` - ViewModel 類別

### MVVM 模式實作
[Source: docs/v1/03_MVVM結構設計.md#1-MVVM-模式概述]

- 使用 CommunityToolkit.Mvvm 的 `[RelayCommand]` 屬性定義命令
- 使用 `ObservableObject` 作為 ViewModel 基類
- 使用 `SetProperty` 方法觸發屬性變更通知

### IExportService 介面
[Source: MD_Viewer/Services/Interfaces/IExportService.cs]

```csharp
public interface IExportService
{
    Task ExportToPdfAsync(string markdown, string outputPath, ExportOptions? options = null);
    // ... 其他方法
}
```

### ExportOptions 模型
[Source: MD_Viewer/Models/ExportOptions.cs]

`ExportOptions` 已包含 PDF 相關屬性：
- `PdfPageSize PageSize` - 頁面大小（A4, Letter, Legal）
- `PdfPageOrientation Orientation` - 頁面方向（Portrait, Landscape）
- `bool IncludePageNumbers` - 是否包含頁碼
- `string? Title` - 標題
- `string? Author` - 作者

### IMarkdownService 現有功能
[Source: MD_Viewer/Services/MarkdownService.cs]

- `RenderToHtml(string markdown)` 方法已實作，可以將 Markdown 轉換為 HTML
- 使用 Markdig 進行渲染，支援進階擴充（數學公式、語法高亮等）

### QuestPDF 使用方式
[Source: docs/技術分析報告.md#轉換工具庫]

QuestPDF 是純 C# PDF 生成庫，推薦使用。基本使用方式：

```csharp
using QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;

Document.Create(container =>
{
    container.Page(page =>
    {
        page.Size(PageSizes.A4);
        page.Margin(2, Unit.Centimetre);
        page.PageColor(Colors.White);
        page.DefaultTextStyle(x => x.FontSize(12));
        
        page.Content()
            .Column(column =>
            {
                column.Item().Text("Title");
                column.Item().Text("Content");
            });
    });
})
.GeneratePdf("output.pdf");
```

**注意**：QuestPDF 需要將 HTML 內容手動轉換為 QuestPDF 元素。可以考慮：
1. 直接從 Markdown 轉換為 QuestPDF 元素（較複雜）
2. 先轉換為 HTML，再解析 HTML 並轉換為 QuestPDF 元素（需要 HTML 解析器）
3. 使用 Markdig 的抽象語法樹（AST）直接生成 QuestPDF 元素（推薦）

### MainViewModel 現有功能
[Source: MD_Viewer/ViewModels/MainViewModel.cs]

- `SupportedExportFormats` 已定義，包含 PDF 格式（目前 `IsEnabled = false`）
- `ExportAsync(ExportFormat? format)` 已實作，支援 HTML 匯出
- `IsExporting`, `ExportMessage` 屬性已實作
- `ShowExportMenu` 屬性已實作
- 匯出選單 UI 已實作

### Windows 平台檔案儲存對話框
[Source: docs/stories/3.2.story.md#Dev Notes]

Windows 平台已實作 `IPlatformFilePicker` 和 `WindowsFilePicker`，可以直接使用：
- `PickSaveFileAsync()` 方法已實作
- 支援檔案類型過濾器
- 支援預設檔名設定

### 前一個 Story 的相關資訊
[Source: docs/stories/3.2.story.md]

- Story 3.2 已完成 HTML 匯出功能實作
- `ExportService.ExportToHtmlAsync()` 已實作，可以參考其錯誤處理和狀態管理方式
- `IPlatformFilePicker` 已實作，可以直接使用
- 匯出選單 UI 已實作，PDF 格式會自動顯示在選單中（當 `IsEnabled = true` 時）

### HTML 到 PDF 轉換策略

由於 QuestPDF 不直接支援 HTML 轉換，需要實作轉換邏輯。建議策略：

1. **使用 Markdig AST 直接生成 PDF**（推薦）
   - 使用 `Markdown.Parse()` 取得抽象語法樹
   - 遍歷 AST 節點，轉換為 QuestPDF 元素
   - 優點：不需要 HTML 解析，效能較好
   - 缺點：需要實作所有 Markdown 元素的轉換邏輯

2. **HTML 解析後轉換**（備選）
   - 使用 HTML 解析器（如 HtmlAgilityPack）解析 HTML
   - 將 HTML 元素轉換為 QuestPDF 元素
   - 優點：可以重用現有的 HTML 渲染結果
   - 缺點：需要額外的 HTML 解析庫，可能遺失樣式資訊

**建議**：先實作基本策略（使用 Markdig AST），支援常見的 Markdown 元素（標題、段落、列表、程式碼、表格），後續可擴充。

### PDF 樣式參考

PDF 樣式應與 HTML 預覽樣式保持一致：
- 字體：使用系統字體（如 -apple-system, 'Segoe UI', 'Microsoft YaHei'）
- 標題：h1 2em, h2 1.5em, h3 1.25em 等
- 程式碼：等寬字體（Consolas, Monaco, Courier New）
- 表格：邊框、交替行背景色
- 行距：1.6（段落）、1.25（標題）

### 頁碼實作

如果 `IncludePageNumbers` 為 true，在頁尾加入頁碼：
- 格式：`第 {currentPage} 頁 / 共 {totalPages} 頁` 或 `{currentPage} / {totalPages}`
- 位置：頁尾中央
- 字體大小：10pt
- 顏色：灰色

### 分頁處理

確保內容不會被截斷：
- 標題和段落應在同一頁
- 程式碼區塊如果過長，可以分頁（但應標示續頁）
- 表格如果過長，可以分頁（但應重複表頭）

## Testing

### 測試標準
[Source: docs/v1/01_系統架構設計.md#7-測試策略]

- 單元測試：ExportService PDF 邏輯測試
- 整合測試：PDF 匯出流程測試
- 手動測試：功能驗證

### 測試檢查清單

1. **匯出選單測試**：
   - [ ] 點擊匯出按鈕可以顯示匯出選單
   - [ ] PDF 格式可以選擇（當 IsEnabled = true 時）
   - [ ] PDF 格式顯示正確的描述

2. **檔案儲存對話框測試**：
   - [ ] 選擇 PDF 格式後顯示檔案儲存對話框
   - [ ] 可以選擇儲存位置
   - [ ] 可以修改檔名
   - [ ] 取消操作正確處理

3. **PDF 匯出測試**：
   - [ ] 匯出的 PDF 檔案包含完整的 Markdown 內容
   - [ ] 匯出的 PDF 檔案可以在 PDF 閱讀器中正常開啟
   - [ ] PDF 內容與預覽一致（樣式、格式）

4. **PDF 格式設定測試**：
   - [ ] A4 頁面大小正確
   - [ ] Letter 頁面大小正確
   - [ ] Legal 頁面大小正確
   - [ ] 直向（Portrait）方向正確
   - [ ] 橫向（Landscape）方向正確
   - [ ] 頁碼功能正確（當 IncludePageNumbers = true 時）

5. **Markdown 元素測試**：
   - [ ] 標題（h1-h6）正確渲染
   - [ ] 段落正確渲染
   - [ ] 列表（有序、無序）正確渲染
   - [ ] 程式碼區塊正確渲染
   - [ ] 行內程式碼正確渲染
   - [ ] 表格正確渲染
   - [ ] 引用區塊正確渲染
   - [ ] 連結正確渲染
   - [ ] 圖片正確渲染（如果支援）

6. **匯出狀態測試**：
   - [ ] 匯出過程中顯示載入狀態
   - [ ] 匯出成功後顯示成功訊息
   - [ ] 匯出失敗時顯示錯誤訊息
   - [ ] 錯誤訊息清楚說明失敗原因

7. **錯誤處理測試**：
   - [ ] 權限不足時顯示適當錯誤訊息
   - [ ] 磁碟空間不足時顯示適當錯誤訊息
   - [ ] 檔案路徑無效時顯示適當錯誤訊息
   - [ ] 使用者取消操作時不顯示錯誤訊息

8. **整合測試**：
   - [ ] 完整的匯出流程：選擇格式 → 選擇儲存位置 → 匯出 → 驗證檔案
   - [ ] 匯出後可以在 PDF 閱讀器中開啟並查看內容
   - [ ] 無記憶體洩漏或效能問題
   - [ ] 大型文件匯出測試（> 1000 行）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | 初始故事建立 | Scrum Master (Bob) |

## Dev Agent Record

_待開發代理實作_

## QA Results

_待 QA 代理審查_

