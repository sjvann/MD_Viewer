# Story 3.1: 編輯功能實作

## Status
Done

## Story

**As a** 使用者,  
**I want** 能夠在應用程式中編輯 Markdown 文件並即時預覽,  
**so that** 可以快速修改文件內容並看到即時效果

## Acceptance Criteria

1. 編輯模式可以正確切換（從預覽模式切換到編輯模式）
2. 編輯器顯示當前檔案的 Markdown 原始內容
3. 編輯器支援基本的 Markdown 語法高亮（可選，使用簡單的文字編輯器）
4. 編輯模式時顯示編輯區和預覽區並排（雙欄佈局）
5. 編輯內容變更時，預覽區即時更新
6. 可以儲存編輯後的內容到檔案
7. 儲存時顯示確認對話框（可選）
8. 編輯模式與預覽模式的切換流暢，無明顯延遲

## Tasks / Subtasks

- [x] **Task 1: 實作編輯模式切換** (AC: 1, 8)
  - [x] 確認 MainViewModel.ToggleEditMode() 已正確實作
  - [x] 確認 CurrentMode 屬性變更正確通知 UI
  - [x] 在 MainPage.xaml 中實作編輯模式 UI 切換邏輯
  - [x] 使用 DataTrigger 根據 CurrentMode 切換編輯區和預覽區顯示

- [x] **Task 2: 建立編輯器元件** (AC: 2, 3)
  - [x] 建立 EditView.xaml 和 EditView.xaml.cs
  - [x] 實作 Editor 控制項（MAUI Editor）顯示 Markdown 內容
  - [x] 綁定 Editor.Text 到 ViewModel 的內容屬性
  - [x] 設定編輯器樣式（字型、行高、邊距等）
  - [x] 實作空狀態顯示

- [x] **Task 3: 實作 EditViewModel** (AC: 2, 5)
  - [x] 建立 EditViewModel.cs
  - [x] 實作 MarkdownContent 屬性（綁定到編輯器）
  - [x] 實作內容變更事件處理（PropertyChanged）
  - [x] 使用直接呼叫 PreviewViewModel.UpdatePreview() 更新預覽
  - [x] 處理載入檔案內容到編輯器
  - [x] 實作防抖（debounce）機制（500ms 延遲）

- [x] **Task 4: 實作雙欄編輯/預覽佈局** (AC: 4)
  - [x] 修改 MainPage.xaml 支援編輯模式佈局
  - [x] 實作 Grid 雙欄佈局
  - [x] 左側：編輯區（EditView）
  - [x] 右側：預覽區（PreviewView）
  - [x] 響應式設計（使用 * 寬度）
  - [x] 使用 DataTrigger 根據 CurrentMode 切換佈局

- [x] **Task 5: 實作即時同步** (AC: 5)
  - [x] 在 EditViewModel 中監聽 MarkdownContent 變更
  - [x] 當內容變更時，觸發 PreviewViewModel.UpdatePreview()
  - [x] 加入防抖（debounce）機制，避免過於頻繁的更新

- [x] **Task 6: 實作檔案儲存功能** (AC: 6, 7)
  - [x] 在 MainViewModel 中加入 SaveFileCommand
  - [x] 實作 SaveFileAsync() 方法
  - [x] 使用 IFileSystemService.WriteFileAsync() 寫入檔案
  - [x] 加入儲存狀態指示（IsSaving, SaveMessage）
  - [x] 處理儲存錯誤（權限、檔案鎖定等）

- [x] **Task 7: 整合編輯功能到主視窗** (AC: 1, 4, 8)
  - [x] 在 MainPage.xaml 中整合 EditView
  - [x] 設定 EditView 的 BindingContext 為 EditViewModel
  - [x] 在工具列中加入儲存按鈕
  - [x] 設定 EditModePreviewView 的 BindingContext

## Dev Notes

### 專案結構參考
[Source: docs/v1/05_專案結構與命名規範.md#1-解決方案結構]

檔案應建立於以下位置：
- EditView：`MD_Viewer/Views/EditView.xaml` 和 `MD_Viewer/Views/EditView.xaml.cs`
- EditViewModel：`MD_Viewer/ViewModels/EditViewModel.cs`
- MainPage 修改：`MD_Viewer/MainPage.xaml`（加入編輯模式佈局）

### 命名空間規範
[Source: docs/v1/05_專案結構與命名規範.md#2-命名空間規範]

- `MD_Viewer.Views` - View 類別
- `MD_Viewer.ViewModels` - ViewModel 類別

### MVVM 模式實作
[Source: docs/v1/03_MVVM結構設計.md#1-MVVM-模式概述]

- 使用 CommunityToolkit.Mvvm 的 `[RelayCommand]` 屬性定義命令
- 使用 `ObservableObject` 作為 ViewModel 基類
- 使用 `SetProperty` 方法觸發屬性變更通知
- 使用 `IMessenger` 進行 ViewModel 間通訊

### MainViewModel 現有功能
[Source: MD_Viewer/ViewModels/MainViewModel.cs]

- `ToggleEditModeCommand` 已實作，可以切換 `CurrentMode`（ViewMode.Preview 和 ViewMode.Edit）
- `IsEditMode` 計算屬性已存在：`public bool IsEditMode => CurrentMode == ViewMode.Edit;`
- `CurrentFileContent` 屬性已存在，用於儲存當前檔案內容
- `FileTreeViewModel` 和 `PreviewViewModel` 已注入並整合

### PreviewViewModel 現有功能
[Source: MD_Viewer/ViewModels/PreviewViewModel.cs]

- `UpdatePreviewCommand` 已實作，接受 `string? markdown` 參數
- 可以透過 `PreviewViewModel.UpdatePreviewCommand.Execute(markdown)` 更新預覽

### 編輯器選擇
[Source: docs/v1/01_系統架構設計.md#3-資料流]

根據架構設計，原本計劃使用 Blazor WebView + Monaco Editor，但由於 .NET 10 preview 相容性問題，暫時使用 MAUI WebView 顯示 HTML。

對於編輯器，建議：
- **階段 1（本故事）**：使用 MAUI `Editor` 控制項作為簡單的文字編輯器
- **階段 2（後續故事）**：可以考慮整合 Monaco Editor 或 CodeMirror（如果技術問題解決）

### 雙欄佈局設計
[Source: docs/v1/01_系統架構設計.md#3-資料流]

編輯模式時，應顯示：
- 左側：編輯區（EditView）- 顯示 Markdown 原始內容
- 右側：預覽區（PreviewView）- 顯示渲染後的 HTML

可以使用 `Grid` 的 `ColumnDefinitions` 實作：
```xml
<Grid.ColumnDefinitions>
    <ColumnDefinition Width="*" />  <!-- 編輯區 -->
    <ColumnDefinition Width="*" />  <!-- 預覽區 -->
</Grid.ColumnDefinitions>
```

### 即時同步機制
[Source: docs/v1/01_系統架構設計.md#3-資料流]

編輯內容變更時，應即時更新預覽。實作方式：
1. 在 `EditViewModel` 中監聽 `MarkdownContent` 屬性變更
2. 當內容變更時，使用 `IMessenger` 發送訊息或直接呼叫 `PreviewViewModel.UpdatePreview()`
3. 可選：加入防抖（debounce）機制，避免過於頻繁的更新（例如：500ms 延遲）

### 檔案儲存功能
[Source: docs/v1/02_介面與類別設計.md#1-核心介面]

- 使用 `IFileSystemService.WriteFileAsync(string filePath, string content)` 寫入檔案
- 需要處理儲存錯誤（權限、檔案鎖定等）
- 可以加入儲存狀態指示（IsSaving, SaveSuccess, SaveError）

### 前一個 Story 的相關資訊
[Source: docs/stories/2.5.story.md]

- Story 2.5 已完成主視窗整合與工具列實作
- MainViewModel 已整合 FileTreeViewModel 和 PreviewViewModel
- 編輯按鈕已實作，可以切換 CurrentMode
- 工具列已實作，包含編輯按鈕和匯出按鈕
- 應用程式啟動時自動載入磁碟列表

### QA 建議（來自 Story 2.5）
[Source: docs/stories/2.5.story.md#QA-Results]

- 建議改進：可以考慮在後續故事中實作進階平板適配邏輯（例如：小螢幕時檔案樹收合）
- 此建議可以在本故事中實作編輯模式的響應式設計

## Testing

### 測試標準
[Source: docs/v1/01_系統架構設計.md#7-測試策略]

- 單元測試：ViewModel 邏輯測試
- 整合測試：UI 綁定測試
- 手動測試：功能驗證

### 測試檢查清單

1. **編輯模式切換測試**：
   - [ ] 點擊編輯按鈕可以切換到編輯模式
   - [ ] 編輯模式時顯示編輯區和預覽區並排
   - [ ] 切換模式時無明顯延遲

2. **編輯器功能測試**：
   - [ ] 編輯器正確顯示當前檔案的 Markdown 內容
   - [ ] 可以在編輯器中輸入和修改內容
   - [ ] 編輯器樣式正確（字型、行高、邊距等）

3. **即時同步測試**：
   - [ ] 編輯內容變更時，預覽區即時更新
   - [ ] 預覽內容正確反映編輯內容
   - [ ] 無明顯延遲或卡頓

4. **檔案儲存測試**：
   - [ ] 可以儲存編輯後的內容
   - [ ] 儲存後檔案內容正確更新
   - [ ] 儲存錯誤正確處理（權限、檔案鎖定等）
   - [ ] 儲存狀態正確顯示

5. **雙欄佈局測試**：
   - [ ] 編輯模式時顯示雙欄佈局
   - [ ] 響應式設計正確（調整視窗大小）
   - [ ] 平板適配正確

6. **整合測試**：
   - [ ] 完整的編輯流程：載入 → 編輯 → 預覽 → 儲存
   - [ ] 編輯模式與預覽模式切換流暢
   - [ ] 無記憶體洩漏或效能問題

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-11 | 1.0 | 初始故事建立 | Scrum Master (Bob) |
| 2025-01-11 | 1.1 | 完成所有實作任務 | Developer (James) |
| 2025-01-11 | 1.2 | QA 審查通過 | QA Agent (Alice) |
| 2025-01-11 | 1.3 | 回應 QA 建議並修正程式碼 | Developer (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- 無編譯錯誤，所有程式碼通過 lint 檢查
- 使用 MAUI Editor 控制項作為編輯器
- 實作防抖機制（500ms 延遲）避免過於頻繁的預覽更新
- 使用 DataTrigger 切換預覽模式和編輯模式
- 編輯模式使用雙欄佈局（編輯區和預覽區並排）
- QA 建議修正：實作 EditViewModel 的 IDisposable，確保 Timer 正確清理
- QA 建議修正：在工具列中顯示儲存訊息（SaveMessage）

### Completion Notes List
1. 成功建立 EditViewModel，管理編輯器內容和即時同步
2. 成功建立 EditView，使用 MAUI Editor 控制項
3. 實作編輯模式切換，使用 DataTrigger 根據 CurrentMode 切換 UI
4. 實作雙欄編輯/預覽佈局，編輯模式時顯示編輯區和預覽區並排
5. 實作即時同步，編輯內容變更時自動更新預覽（含防抖機制）
6. 實作檔案儲存功能，包含儲存狀態指示和錯誤處理
7. 在工具列中加入儲存按鈕
8. 整合編輯功能到主視窗，設定所有 BindingContext
9. QA 建議修正：實作 EditViewModel 的 IDisposable 介面，在 Dispose() 方法中清理 Timer，避免記憶體洩漏
10. QA 建議修正：在工具列中顯示儲存訊息（SaveMessage），使用 DataTrigger 控制顯示/隱藏

### File List
**新建檔案：**
- MD_Viewer/ViewModels/EditViewModel.cs（編輯 ViewModel）
- MD_Viewer/Views/EditView.xaml（編輯器 UI）
- MD_Viewer/Views/EditView.xaml.cs（編輯器 Code-Behind）

**修改檔案：**
- MD_Viewer/ViewModels/EditViewModel.cs（實作 IDisposable 介面，清理 Timer 資源）
- MD_Viewer/ViewModels/MainViewModel.cs（加入 EditViewModel、SaveFileCommand、儲存狀態屬性）
- MD_Viewer/MainPage.xaml（加入編輯模式雙欄佈局、儲存按鈕、儲存訊息顯示）
- MD_Viewer/MainPage.xaml.cs（設定 EditView 和 EditModePreviewView 的 BindingContext）
- MD_Viewer/MauiProgram.cs（註冊 EditViewModel）

## QA Results

### 審查日期
2025-01-11

### 審查者
QA Agent (Auto)

### Acceptance Criteria 驗證

| AC | 描述 | 狀態 | 備註 |
|----|------|------|------|
| AC 1 | 編輯模式可以正確切換（從預覽模式切換到編輯模式） | ✅ 通過 | ToggleEditModeCommand 已實作，使用 DataTrigger 切換 UI |
| AC 2 | 編輯器顯示當前檔案的 Markdown 原始內容 | ✅ 通過 | EditViewModel.LoadContent() 已實作，CurrentFileContent 變更時自動載入 |
| AC 3 | 編輯器支援基本的 Markdown 語法高亮（可選） | ⚠️ 部分通過 | 使用 MAUI Editor 控制項，無語法高亮（符合 Story 說明「可選」） |
| AC 4 | 編輯模式時顯示編輯區和預覽區並排（雙欄佈局） | ✅ 通過 | 使用 Grid 雙欄佈局，編輯區和預覽區各佔 50% 寬度 |
| AC 5 | 編輯內容變更時，預覽區即時更新 | ✅ 通過 | 實作防抖機制（500ms），內容變更時自動更新預覽 |
| AC 6 | 可以儲存編輯後的內容到檔案 | ✅ 通過 | SaveFileCommand 已實作，使用 IFileSystemService.WriteFileAsync() |
| AC 7 | 儲存時顯示確認對話框（可選） | ⚠️ 部分通過 | 未實作確認對話框，但顯示儲存狀態訊息（SaveMessage），符合 Story 說明「可選」 |
| AC 8 | 編輯模式與預覽模式的切換流暢，無明顯延遲 | ✅ 通過 | 使用 DataTrigger 切換，無額外處理邏輯，切換應流暢 |

### 程式碼品質審查

#### EditViewModel.cs
- ✅ 使用 CommunityToolkit.Mvvm 的 ObservableObject
- ✅ 實作防抖機制避免過於頻繁的預覽更新
- ✅ 使用 MainThread.BeginInvokeOnMainThread() 確保 UI 更新在主執行緒
- ✅ 錯誤處理完整（try-catch）
- ⚠️ **建議改進**：`_debounceTimer` 未實作 IDisposable，可能導致記憶體洩漏（見下方詳細說明）

#### MainViewModel.cs
- ✅ 正確整合 EditViewModel
- ✅ SaveFileCommand 使用 CanExecute 條件綁定
- ✅ 儲存狀態管理完整（IsSaving, SaveMessage）
- ✅ 錯誤處理完整
- ✅ 自動清除儲存訊息（3 秒後）
- ✅ 當檔案變更時自動切換回預覽模式（良好的 UX）

#### EditView.xaml
- ✅ 使用 MAUI Editor 控制項
- ✅ 正確綁定到 MarkdownContent
- ✅ 實作空狀態顯示
- ✅ 編輯器樣式設定適當（字型、大小、邊距）

#### MainPage.xaml
- ✅ 使用 DataTrigger 切換預覽模式和編輯模式
- ✅ 雙欄佈局實作正確
- ✅ 響應式設計（使用 * 寬度）
- ✅ 儲存按鈕正確綁定

#### MainPage.xaml.cs
- ✅ 正確設定所有 BindingContext
- ✅ 錯誤處理完整

### 優點

1. **架構設計良好**
   - 符合 MVVM 模式
   - 使用 CommunityToolkit.Mvvm
   - ViewModel 間通訊清晰（直接引用 PreviewViewModel）

2. **即時同步實作優秀**
   - 使用防抖機制避免過於頻繁的更新
   - 500ms 延遲設定合理
   - 使用 MainThread 確保 UI 更新安全

3. **使用者體驗良好**
   - 切換檔案時自動切換回預覽模式
   - 儲存狀態訊息自動清除
   - 儲存按鈕狀態正確反映 CanSave

4. **錯誤處理完整**
   - 所有關鍵操作都有 try-catch
   - 錯誤訊息正確顯示

5. **程式碼品質**
   - 無 lint 錯誤
   - 命名規範正確
   - 註解完整

### 建議改進

1. **EditViewModel 資源清理（重要）** ✅ **已修正**
   - **問題**：`_debounceTimer` 使用 `System.Threading.Timer`，但 `EditViewModel` 未實作 `IDisposable`，可能導致記憶體洩漏
   - **影響**：中等（ViewModel 通常為 Transient，但長時間運行可能累積未釋放的 Timer）
   - **修正**：已實作 `IDisposable` 介面，在 `Dispose()` 方法中清理 Timer
   - **狀態**：✅ 已完成

2. **儲存確認對話框（可選）**
   - **問題**：AC 7 提到「儲存時顯示確認對話框（可選）」，目前未實作
   - **影響**：低（Story 說明為「可選」，且已有儲存狀態訊息）
   - **建議**：可以考慮在後續故事中實作確認對話框，提升使用者體驗
   - **優先級**：低

3. **儲存訊息 UI 顯示（可選）** ✅ **已修正**
   - **問題**：`SaveMessage` 屬性已實作，但 MainPage.xaml 中未顯示儲存訊息
   - **影響**：低（功能正常，但使用者無法看到儲存狀態）
   - **修正**：已在工具列中加入 Label 顯示儲存訊息，使用 DataTrigger 控制顯示/隱藏
   - **狀態**：✅ 已完成

4. **編輯器語法高亮（可選）**
   - **問題**：AC 3 提到「編輯器支援基本的 Markdown 語法高亮（可選）」，目前使用簡單的 Editor 控制項
   - **影響**：低（Story 說明為「可選」，且符合階段 1 的實作策略）
   - **建議**：可以考慮在後續故事中整合 Monaco Editor 或 CodeMirror
   - **優先級**：低

### 測試建議

#### 手動測試項目
1. ⏳ 編輯模式切換測試（需手動測試）
2. ⏳ 編輯器功能測試（需手動測試）
3. ⏳ 即時同步測試（需手動測試）
4. ⏳ 檔案儲存測試（需手動測試）
5. ⏳ 雙欄佈局測試（需手動測試）
6. ⏳ 整合測試（需手動測試）

### 結論

**審查結果：✅ 通過（有建議改進）**

Story 3.1 的實作符合大部分驗收標準，程式碼品質良好，架構設計正確。所有核心功能已正確實作，錯誤處理完整，使用者體驗良好。存在一個中等優先級的改進建議（EditViewModel 資源清理），但不影響故事的核心功能。

**建議動作：**
1. ✅ 批准 Story 3.1 通過
2. ✅ **已完成**：實作 EditViewModel 的 IDisposable，確保 Timer 正確清理
3. ✅ **已完成**：實作儲存訊息 UI 顯示，提升使用者體驗

### 審查者
QA Agent (Auto)

