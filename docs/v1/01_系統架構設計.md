# 系統架構設計文件

## 1. 整體架構概述

### 1.1 架構模式
採用 **MVVM (Model-View-ViewModel)** 模式，結合 **分層架構 (Layered Architecture)** 和 **平台抽象層 (Platform Abstraction Layer)**。

### 1.2 架構分層

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   MAUI Views │  │ Blazor Views │  │   Toolbar     │  │
│  │   (XAML)     │  │  (WebView)   │  │   (XAML)      │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                 │                  │          │
│  ┌──────┴─────────────────┴──────────────────┴──────┐  │
│  │              ViewModel Layer (MVVM)                │  │
│  │  MainViewModel │ FileTreeViewModel │ PreviewVM     │  │
│  └────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────┴─────────────────────────────────┐
│                    Business Logic Layer                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Services   │  │   Services   │  │   Services   │   │
│  │  Interface   │  │  Interface   │  │  Interface   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
│         │                 │                  │           │
│  ┌──────┴─────────────────┴──────────────────┴──────┐   │
│  │         Service Implementations (C#)               │   │
│  │  FileSystemService │ MarkdownService │ ExportSvc   │   │
│  └────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────┴─────────────────────────────────┐
│              Platform Abstraction Layer                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Windows    │  │    macOS     │  │   Android    │   │
│  │  Platform    │  │   Platform   │  │   Platform   │   │
│  │  Services    │  │   Services   │  │   Services   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└───────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────┴─────────────────────────────────┐
│              External Dependencies                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   Markdig    │  │  QuestPDF    │  │  OpenXml     │   │
│  │  (C#)        │  │  (C#)        │  │  (C#)        │   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │   marked.js  │  │ highlight.js │  │    KaTeX     │   │
│  │  (TypeScript)│  │  (TypeScript)│  │  (TypeScript)│   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
└───────────────────────────────────────────────────────────┘
```

## 2. 核心模組設計

### 2.1 模組劃分

#### 模組 1：檔案系統模組 (FileSystem Module)
- **職責**：跨平台檔案系統操作
- **核心類別**：
  - `IFileSystemService` (介面)
  - `FileSystemService` (實作)
  - `PlatformFileSystemService` (平台特定實作)
- **依賴**：無外部依賴（僅使用 .NET 標準庫）

#### 模組 2：Markdown 處理模組 (Markdown Module)
- **職責**：Markdown 解析、渲染、編輯
- **核心類別**：
  - `IMarkdownService` (介面)
  - `MarkdownService` (C# 端實作)
  - `MarkdownRenderer` (TypeScript 端)
- **依賴**：
  - Markdig (C#)
  - marked.js, highlight.js, KaTeX (TypeScript)

#### 模組 3：匯出模組 (Export Module)
- **職責**：格式轉換（HTML, PDF, DOCX, ODF）
- **核心類別**：
  - `IExportService` (介面)
  - `ExportService` (實作)
  - `HtmlExporter`, `PdfExporter`, `DocxExporter`, `OdfExporter`
- **依賴**：
  - QuestPDF (PDF)
  - DocumentFormat.OpenXml (DOCX/ODF)

#### 模組 4：UI 模組 (UI Module)
- **職責**：使用者介面呈現
- **核心類別**：
  - Views (XAML)
  - ViewModels (MVVM)
  - Blazor Components (WebView)
- **依賴**：MAUI, Blazor WebView

#### 模組 5：平台適配模組 (Platform Module)
- **職責**：平台特定功能實作
- **核心類別**：
  - `IPlatformFileSystem` (介面)
  - `WindowsFileSystem`, `MacFileSystem`, `AndroidFileSystem`
- **依賴**：平台特定 API

## 3. 資料流設計

### 3.1 檔案選擇流程

```
User Action (點選檔案)
    ↓
FileTreeView (XAML)
    ↓
FileTreeViewModel (ViewModel)
    ↓
IFileSystemService.ReadFileAsync()
    ↓
FileSystemService (Service)
    ↓
PlatformFileSystemService (Platform)
    ↓
File.ReadAllTextAsync() (.NET)
    ↓
返回檔案內容
    ↓
MainViewModel.CurrentFileContent
    ↓
PreviewViewModel (ViewModel)
    ↓
MarkdownPreview (Blazor WebView)
    ↓
TypeScript Renderer (marked.js)
    ↓
顯示渲染結果
```

### 3.2 編輯模式流程

```
User Action (點選編輯按鈕)
    ↓
MainViewModel.ToggleEditMode()
    ↓
MainViewModel.CurrentMode = ViewMode.Edit
    ↓
MainPage 切換 UI (顯示編輯區 + 預覽區)
    ↓
MarkdownEditor (Blazor WebView)
    ↓
Monaco Editor (TypeScript)
    ↓
User 輸入內容
    ↓
JavaScript Interop → C# (即時同步)
    ↓
PreviewViewModel.UpdatePreview()
    ↓
MarkdownPreview 更新
```

### 3.3 匯出流程

```
User Action (點選匯出按鈕)
    ↓
ExportDialog (選擇格式)
    ↓
MainViewModel.ExportCommand
    ↓
IExportService.ExportAsync()
    ↓
ExportService (根據格式選擇)
    ↓
HtmlExporter / PdfExporter / DocxExporter / OdfExporter
    ↓
IMarkdownService.RenderToHtml() (如需)
    ↓
生成檔案
    ↓
SaveFileDialog (選擇儲存位置)
    ↓
完成匯出
```

## 4. 依賴注入設計

### 4.1 服務註冊 (MauiProgram.cs)

```csharp
public static class MauiProgram
{
    public static MauiApp CreateMauiApp()
    {
        var builder = MauiApp.CreateBuilder();
        builder
            .UseMauiApp<App>()
            .ConfigureFonts(fonts => { /* ... */ });

        // 註冊服務
        ConfigureServices(builder.Services);
        
        return builder.Build();
    }

    private static void ConfigureServices(IServiceCollection services)
    {
        // 平台特定服務
        #if WINDOWS
        services.AddSingleton<IPlatformFileSystem, WindowsFileSystem>();
        #elif MACCATALYST
        services.AddSingleton<IPlatformFileSystem, MacFileSystem>();
        #elif ANDROID
        services.AddSingleton<IPlatformFileSystem, AndroidFileSystem>();
        #endif

        // 核心服務
        services.AddSingleton<IFileSystemService, FileSystemService>();
        services.AddSingleton<IMarkdownService, MarkdownService>();
        services.AddSingleton<IExportService, ExportService>();

        // ViewModels
        services.AddTransient<MainViewModel>();
        services.AddTransient<FileTreeViewModel>();
        services.AddTransient<PreviewViewModel>();
    }
}
```

### 4.2 依賴關係圖

```
MainViewModel
    ├── IFileSystemService
    ├── IMarkdownService
    ├── IExportService
    └── FileTreeViewModel
            └── IFileSystemService

FileSystemService
    └── IPlatformFileSystem

MarkdownService
    └── (無依賴，使用 Markdig)

ExportService
    ├── IMarkdownService
    ├── HtmlExporter
    ├── PdfExporter
    ├── DocxExporter
    └── OdfExporter
```

## 5. 通訊機制

### 5.1 ViewModel 間通訊

使用 **Messenger Pattern** (CommunityToolkit.Mvvm)：

```csharp
// 檔案選擇訊息
public class FileSelectedMessage : ValueChangedMessage<FileNode>
{
    public FileSelectedMessage(FileNode file) : base(file) { }
}

// 在 FileTreeViewModel 中發送
_messenger.Send(new FileSelectedMessage(selectedFile));

// 在 MainViewModel 中接收
_messenger.Register<FileSelectedMessage>(this, (r, m) => {
    CurrentFile = m.Value;
    LoadFileContent(m.Value.Path);
});
```

### 5.2 C# ↔ TypeScript 通訊

使用 **JavaScript Interop** (Blazor WebView)：

```csharp
// C# → TypeScript
await webView.EvaluateJavaScriptAsync($"renderMarkdown('{content}')");

// TypeScript → C#
[JSInvokable]
public static void OnContentChanged(string content)
{
    // 處理內容變更
}
```

## 6. 錯誤處理策略

### 6.1 分層錯誤處理

1. **Service Layer**：捕獲並記錄詳細錯誤
2. **ViewModel Layer**：轉換為使用者友好的錯誤訊息
3. **View Layer**：顯示錯誤提示

### 6.2 錯誤類型

- `FileAccessException`：檔案存取權限問題
- `FileNotFoundException`：檔案不存在
- `InvalidMarkdownException`：Markdown 格式錯誤
- `ExportException`：匯出失敗

## 7. 效能優化策略

### 7.1 快取機制

- **檔案內容快取**：快取最近讀取的檔案
- **渲染結果快取**：快取已渲染的 HTML
- **目錄結構快取**：快取已讀取的目錄樹

### 7.2 非同步處理

- 所有 I/O 操作使用 `async/await`
- 大型檔案使用串流讀取
- UI 更新使用 `Dispatcher` 確保在主執行緒

### 7.3 虛擬化

- 檔案樹使用 `CollectionView` 的虛擬化
- 大型 Markdown 內容使用分頁渲染

## 8. 安全性考量

### 8.1 檔案存取安全

- 驗證檔案路徑，防止路徑遍歷攻擊
- 限制可存取的目錄範圍（平台特定）
- 檢查檔案大小，防止記憶體溢出

### 8.2 內容安全

- Markdown 渲染時過濾危險 HTML 標籤
- JavaScript 執行限制在 WebView 沙盒中

## 9. 可擴充性設計

### 9.1 插件機制（未來擴充）

- 定義 `IMarkdownExtension` 介面
- 支援自訂 Markdown 擴充語法
- 支援自訂匯出格式

### 9.2 主題系統

- 定義 `IThemeProvider` 介面
- 支援亮色/暗色主題
- 支援自訂 CSS 樣式

