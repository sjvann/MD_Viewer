# Markdown 離線預覽器 - .NET MAUI 技術分析報告

## 一、需求分析

### 1.1 核心功能需求

#### 檔案瀏覽模組
- **磁碟選擇器**：支援 Windows 磁碟選擇（C:, D:, E: 等）
- **目錄樹狀結構**：遞迴展開資料夾，顯示完整目錄結構
- **檔案過濾**：僅顯示 Markdown 支援的副檔名（.md, .markdown, .mdown, .mkd, .mkdn, .mdwn 等）

#### 預覽模組
- **即時預覽**：點選檔案後，右側即時顯示渲染後的 Markdown 內容
- **樣式美觀**：支援語法高亮、表格、數學公式等進階功能

#### 編輯模組
- **雙欄模式**：編輯按鈕觸發後，切換為左側編輯區、右側預覽區
- **即時同步**：編輯區內容變更時，預覽區即時更新

#### 轉換模組
- **多格式支援**：
  - HTML（優先實作，難度低）
  - PDF（中等難度）
  - DOCX（中等難度）
  - ODF（OpenDocument Format，中等難度）

### 1.2 平台需求
- ✅ **Windows**：桌面應用程式
- ✅ **macOS**：可上架 App Store
- ✅ **Android**：可上架 Google Play
- ✅ **iOS**：可上架 App Store（未來擴充）
- ✅ **離線運行**：無需網路連線
- ✅ **平板支援**：響應式 UI 設計

---

## 二、技術架構建議

### 2.1 技術棧選擇

#### 核心框架
**推薦：.NET MAUI (.NET 9/10)**
- **理由**：
  - 單一程式碼庫支援多平台（Windows、macOS、Android、iOS）
  - 使用 C# 開發，符合技術要求
  - 原生效能，非 WebView 包裝
  - 完整的檔案系統存取能力
  - 可打包為原生應用程式，符合商店上架要求
  - 支援平板和手機的響應式設計

#### UI 框架選擇

**方案 A：.NET MAUI 原生 UI（推薦）**
- 使用 XAML + C# Code-Behind
- 優點：最佳效能、原生外觀、完整平台整合
- 缺點：需學習 XAML

**方案 B：.NET MAUI Blazor Hybrid**
- 使用 Blazor + C# + TypeScript（透過 JavaScript Interop）
- 優點：可重用 Web 技術、支援 TypeScript
- 缺點：效能略低於原生 UI

**方案 C：混合方案（最佳平衡）**
- 主要 UI 使用 MAUI 原生（檔案瀏覽器、工具列）
- Markdown 渲染使用 Blazor WebView（支援 TypeScript/JavaScript 生態系統）
- 優點：結合兩者優勢

#### Markdown 解析與渲染

**C# 端選項：**
- **Markdig**：功能完整，效能優秀，支援擴充
- **MarkdownSharp**：輕量級，但功能較少

**JavaScript/TypeScript 端（WebView 中使用）：**
- **marked.js** 或 **markdown-it**：透過 WebView 執行
- **highlight.js**：程式碼高亮
- **KaTeX** 或 **MathJax**：數學公式

#### 檔案系統操作
- **System.IO**：標準 .NET 檔案系統 API
- **Microsoft.Maui.Storage**：MAUI 跨平台檔案存取
- **Platform-specific APIs**：各平台特定功能（如 Android 的 SAF）

#### 轉換工具庫

**C# 端：**
- **HTML**：直接使用 Markdown 渲染結果
- **PDF**：
  - **QuestPDF**：純 C# PDF 生成（推薦）
  - **PuppeteerSharp**：透過 Chromium 轉換（較重）
- **DOCX**：
  - **DocX**（Xceed）：商業授權
  - **ClosedXML**：開源，需自行實作 DOCX 結構
  - **DocumentFormat.OpenXml**：微軟官方，功能完整但複雜
- **ODF**：
  - **DocumentFormat.OpenXml**：可處理 ODF
  - **自行實作**：ODF 為 ZIP + XML 結構

### 2.2 架構設計

```
┌─────────────────────────────────────────┐
│      .NET MAUI Application             │
├─────────────────────────────────────────┤
│                                         │
│  ┌──────────────┬──────────────────┐   │
│  │              │                  │   │
│  │  檔案瀏覽區   │   內容顯示區      │   │
│  │ (MAUI View)  │  (Blazor/MAUI)   │   │
│  │              │                  │   │
│  │ ┌──────────┐ │ ┌──────────────┐ │   │
│  │ │磁碟選擇  │ │ │  預覽模式     │ │   │
│  │ └──────────┘ │ │ (WebView渲染) │ │   │
│  │              │ └──────────────┘ │   │
│  │ ┌──────────┐ │ 或               │   │
│  │ │目錄樹    │ │ ┌──────┬──────┐ │   │
│  │ │(TreeView)│ │ │編輯區│預覽區│ │   │
│  │ │          │ │ │      │      │ │   │
│  │ └──────────┘ │ └──────┴──────┘ │   │
│  │              │                  │   │
│  └──────────────┴──────────────────┘   │
│                                         │
│  ┌──────────────────────────────────┐   │
│  │      Services Layer (C#)         │   │
│  │  - FileSystemService             │   │
│  │  - MarkdownService               │   │
│  │  - ExportService                 │   │
│  └──────────────────────────────────┘   │
│                                         │
│  ┌──────────────────────────────────┐   │
│  │   Blazor WebView (TypeScript)    │   │
│  │  - Markdown Renderer             │   │
│  │  - Syntax Highlighting           │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 2.3 模組劃分

#### 1. **FileSystemService (C#)**
- 職責：跨平台檔案系統操作
- 功能：
  - 取得磁碟列表（Windows）/ 根目錄（macOS/Android）
  - 遞迴讀取目錄結構
  - 過濾 Markdown 檔案
  - 監聽檔案變更（可選）
- 平台特定處理：
  - Windows：直接存取檔案系統
  - macOS：需處理沙盒限制
  - Android：使用 Storage Access Framework (SAF)

#### 2. **MarkdownService (C# + TypeScript)**
- **C# 端**：
  - 使用 Markdig 進行初步解析
  - 準備資料給 WebView
- **TypeScript/JavaScript 端（WebView）**：
  - 使用 marked.js 或 markdown-it 渲染
  - highlight.js 程式碼高亮
  - KaTeX 數學公式

#### 3. **EditorComponent (Blazor/MAUI)**
- 職責：編輯器功能
- 實作方式：
  - 使用 Blazor WebView 嵌入編輯器（Monaco Editor 或 CodeMirror）
  - 或使用 MAUI Editor 控制項
- 功能：
  - 雙欄編輯/預覽模式
  - 即時同步更新
  - JavaScript Interop 橋接

#### 4. **ExportService (C#)**
- 職責：格式轉換
- 功能：
  - HTML 匯出（直接使用渲染結果）
  - PDF 匯出（QuestPDF）
  - DOCX 匯出（DocumentFormat.OpenXml）
  - ODF 匯出（自行實作或使用套件）

#### 5. **UI Components**
- **MAUI 原生**：
  - FileTreeView：檔案樹元件（使用 CollectionView 或自訂控制項）
  - Toolbar：工具列（編輯、轉換按鈕）
- **Blazor WebView**：
  - PreviewPanel：預覽面板
  - EditorPanel：編輯面板（Monaco Editor）

---

## 三、實作方案

### 3.1 專案結構建議

```
MD_Viewer/
├── MD_Viewer/
│   ├── Platforms/              # 平台特定實作
│   │   ├── Android/
│   │   ├── Windows/
│   │   └── MacCatalyst/
│   ├── Views/                  # MAUI Views (XAML)
│   │   ├── MainPage.xaml
│   │   ├── FileTreeView.xaml
│   │   └── ToolbarView.xaml
│   ├── ViewModels/             # MVVM ViewModels
│   │   ├── MainViewModel.cs
│   │   ├── FileTreeViewModel.cs
│   │   └── PreviewViewModel.cs
│   ├── Services/               # 業務邏輯服務
│   │   ├── FileSystemService.cs
│   │   ├── MarkdownService.cs
│   │   └── ExportService.cs
│   ├── Models/                 # 資料模型
│   │   ├── FileNode.cs
│   │   └── ExportOptions.cs
│   ├── Resources/              # 資源檔案
│   │   ├── Styles/
│   │   └── Fonts/
│   ├── MauiProgram.cs         # 應用程式入口
│   └── App.xaml
│
├── MD_Viewer.Blazor/           # Blazor 元件（可選）
│   ├── Components/
│   │   ├── MarkdownPreview.razor
│   │   └── MarkdownEditor.razor
│   ├── wwwroot/
│   │   ├── js/
│   │   │   ├── markdown-renderer.ts
│   │   │   └── editor.ts
│   │   └── css/
│   └── _Imports.razor
│
├── MD_Viewer.Core/             # 共享核心邏輯（可選）
│   └── Utilities/
│
└── MD_Viewer.sln
```

### 3.2 核心功能實作要點

#### 檔案樹實作（C#）
```csharp
public class FileSystemService
{
    public async Task<List<FileNode>> ReadDirectoryAsync(string path)
    {
        var nodes = new List<FileNode>();
        
        try
        {
            var items = Directory.GetFileSystemEntries(path);
            
            foreach (var item in items)
            {
                var fileInfo = new FileInfo(item);
                var dirInfo = new DirectoryInfo(item);
                
                if (dirInfo.Exists)
                {
                    nodes.Add(new FileNode
                    {
                        Type = FileNodeType.Directory,
                        Name = dirInfo.Name,
                        Path = dirInfo.FullName,
                        Children = await ReadDirectoryAsync(dirInfo.FullName)
                    });
                }
                else if (fileInfo.Exists && IsMarkdownFile(fileInfo.Extension))
                {
                    nodes.Add(new FileNode
                    {
                        Type = FileNodeType.File,
                        Name = fileInfo.Name,
                        Path = fileInfo.FullName
                    });
                }
            }
        }
        catch (UnauthorizedAccessException)
        {
            // 處理權限問題
        }
        
        return nodes;
    }
    
    private bool IsMarkdownFile(string extension)
    {
        var markdownExtensions = new[] { ".md", ".markdown", ".mdown", ".mkd" };
        return markdownExtensions.Contains(extension.ToLower());
    }
}
```

#### 平台特定檔案存取

**Windows：**
```csharp
public async Task<List<string>> GetDrivesAsync()
{
    return DriveInfo.GetDrives()
        .Where(d => d.IsReady)
        .Select(d => d.Name)
        .ToList();
}
```

**Android（需使用 SAF）：**
```csharp
#if ANDROID
public async Task<string> RequestStorageAccess()
{
    // 使用 Android Storage Access Framework
    // 需要 Activity 和 Intent
}
#endif
```

**macOS（處理沙盒）：**
```csharp
#if MACCATALYST
public async Task<string> RequestFileAccess()
{
    // 使用 NSOpenPanel 或 NSDocumentPicker
}
#endif
```

#### Markdown 渲染（混合方案）

**C# 端準備：**
```csharp
public class MarkdownService
{
    private readonly MarkdownPipeline _pipeline;
    
    public MarkdownService()
    {
        _pipeline = new MarkdownPipelineBuilder()
            .UseAdvancedExtensions()
            .UseMathematics()
            .UseSyntaxHighlighting()
            .Build();
    }
    
    public string RenderToHtml(string markdown)
    {
        return Markdown.ToHtml(markdown, _pipeline);
    }
}
```

**TypeScript 端（WebView 中）：**
```typescript
// markdown-renderer.ts
import { marked } from 'marked';
import hljs from 'highlight.js';
import katex from 'katex';

export function renderMarkdown(content: string): string {
    marked.setOptions({
        highlight: (code, lang) => {
            return hljs.highlightAuto(code).value;
        }
    });
    
    let html = marked.parse(content);
    
    // 處理數學公式
    html = html.replace(/\$\$(.*?)\$\$/g, (match, formula) => {
        return katex.renderToString(formula, { displayMode: true });
    });
    
    return html;
}
```

#### 預覽模式切換（MVVM）
```csharp
public class MainViewModel : ObservableObject
{
    private ViewMode _currentMode = ViewMode.Preview;
    
    public ViewMode CurrentMode
    {
        get => _currentMode;
        set => SetProperty(ref _currentMode, value);
    }
    
    public void ToggleEditMode()
    {
        CurrentMode = CurrentMode == ViewMode.Preview 
            ? ViewMode.Edit 
            : ViewMode.Preview;
    }
}

public enum ViewMode
{
    Preview,
    Edit
}
```

#### 轉換功能實作

**HTML 匯出：**
```csharp
public async Task ExportToHtmlAsync(string markdown, string outputPath)
{
    var html = RenderToHtml(markdown);
    var fullHtml = $@"
<!DOCTYPE html>
<html>
<head>
    <link rel=""stylesheet"" href=""styles.css"">
</head>
<body>{html}</body>
</html>";
    
    await File.WriteAllTextAsync(outputPath, fullHtml);
}
```

**PDF 匯出（使用 QuestPDF）：**
```csharp
public async Task ExportToPdfAsync(string markdown, string outputPath)
{
    var html = RenderToHtml(markdown);
    
    // 使用 QuestPDF 或 PuppeteerSharp
    // QuestPDF 範例：
    Document.Create(container =>
    {
        container.Page(page =>
        {
            page.Content().Column(column =>
            {
                // 將 HTML 轉換為 QuestPDF 元素
                // 需要 HTML 解析器
            });
        });
    })
    .GeneratePdf(outputPath);
}
```

---

## 四、技術難度評估

| 功能模組 | 難度 | 預估工時 | 備註 |
|---------|------|---------|------|
| MAUI 專案設定 | ⭐⭐ | 1-2 天 | 多平台設定 |
| 檔案瀏覽器 | ⭐⭐⭐ | 3-4 天 | 需處理平台差異 |
| Markdown 預覽 | ⭐⭐ | 2 天 | 整合 C# + TS |
| 編輯模式 | ⭐⭐⭐ | 3 天 | Blazor/MAUI 整合 |
| HTML 匯出 | ⭐ | 0.5 天 | 最簡單 |
| PDF 匯出 | ⭐⭐⭐ | 3-4 天 | QuestPDF 學習曲線 |
| DOCX 匯出 | ⭐⭐⭐⭐ | 4-5 天 | OpenXml 複雜 |
| ODF 匯出 | ⭐⭐⭐⭐ | 4-5 天 | 需了解 ODF 結構 |
| 平台特定適配 | ⭐⭐⭐⭐ | 5-7 天 | Android SAF、macOS 沙盒 |

**總預估工時**：約 25-35 個工作天

---

## 五、建議實作順序

### Phase 1：核心功能（MVP）- Windows 優先
1. ✅ MAUI 專案建立與基礎 UI
2. ✅ 檔案瀏覽器（Windows 平台）
3. ✅ Markdown 預覽（WebView + TypeScript）
4. ✅ 檔案過濾（僅顯示 .md 等）

### Phase 2：編輯功能
5. ✅ 編輯模式切換
6. ✅ 雙欄編輯/預覽
7. ✅ 即時同步（JavaScript Interop）

### Phase 3：轉換功能
8. ✅ HTML 匯出
9. ✅ PDF 匯出
10. ✅ DOCX 匯出（可選）
11. ✅ ODF 匯出（可選）

### Phase 4：多平台適配
12. ✅ macOS 適配與測試
13. ✅ Android 適配（SAF 整合）
14. ✅ 平板 UI 優化
15. ✅ 商店上架準備

---

## 六、技術風險與建議

### 6.1 潛在風險

1. **Android 檔案存取限制**
   - **風險**：Android 10+ 限制直接檔案系統存取
   - **解決方案**：使用 Storage Access Framework (SAF)
   - **影響**：需要重新設計檔案選擇流程

2. **macOS 沙盒限制**
   - **風險**：App Store 上架需啟用沙盒
   - **解決方案**：使用 NSOpenPanel 讓使用者選擇目錄
   - **影響**：無法直接瀏覽整個檔案系統

3. **大型檔案效能**
   - **風險**：大型 Markdown 檔案渲染可能卡頓
   - **解決方案**：虛擬滾動、分頁渲染、非同步處理

4. **PDF 轉換樣式問題**
   - **風險**：HTML 到 PDF 的樣式轉換可能不完美
   - **解決方案**：使用 QuestPDF 直接生成，或 PuppeteerSharp 確保樣式一致

5. **TypeScript 整合複雜度**
   - **風險**：C# 與 TypeScript 之間的資料傳遞可能複雜
   - **解決方案**：使用 JavaScript Interop，定義清晰的介面契約

### 6.2 優化建議

- **使用 MVVM 模式**：提高程式碼可維護性
- **依賴注入**：使用 .NET MAUI 內建的 DI 容器
- **非同步處理**：所有 I/O 操作使用 async/await
- **快取機制**：快取已讀取的檔案內容和渲染結果
- **響應式設計**：使用 MAUI 的 AdaptiveLayout 適配不同螢幕尺寸
- **主題支援**：實作亮色/暗色主題切換

### 6.3 商店上架注意事項

**Android (Google Play)：**
- 需要處理權限請求（檔案存取）
- 使用 SAF 而非直接檔案存取
- 準備隱私政策
- 設定目標 SDK 版本

**macOS (App Store)：**
- 啟用 App Sandbox
- 使用 NSOpenPanel 而非直接檔案存取
- 簽署應用程式
- 準備應用程式描述和截圖

---

## 七、推薦套件清單

### 核心依賴
```xml
<PackageReference Include="Microsoft.Maui.Controls" Version="9.0.0" />
<PackageReference Include="Microsoft.Maui.Controls.Compatibility" Version="9.0.0" />
```

### Markdown 相關
```xml
<PackageReference Include="Markdig" Version="0.33.0" />
```

### 轉換相關
```xml
<PackageReference Include="QuestPDF" Version="2024.10.0" />
<PackageReference Include="DocumentFormat.OpenXml" Version="3.0.0" />
```

### UI 增強（可選）
```xml
<PackageReference Include="CommunityToolkit.Maui" Version="9.0.0" />
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.3.2" />
```

### Blazor 整合（如使用）
```xml
<PackageReference Include="Microsoft.AspNetCore.Components.WebView.Maui" Version="9.0.0" />
```

### TypeScript/JavaScript 套件（npm）
```json
{
  "dependencies": {
    "marked": "^11.0.0",
    "highlight.js": "^11.9.0",
    "katex": "^0.16.9"
  }
}
```

---

## 八、結論

使用 **.NET MAUI (.NET 9/10)** 開發此專案完全可行，且符合您的技術要求：

✅ **C# 開發**：完全使用 C#，符合熟悉技術棧  
✅ **TypeScript 支援**：可透過 Blazor WebView 整合 TypeScript  
✅ **多平台支援**：Windows、macOS、Android 一碼多平台  
✅ **商店上架**：可打包為原生應用程式，符合上架要求  
✅ **離線運行**：完全離線，無需網路  

**建議採用混合架構**：
- 主要 UI 使用 MAUI 原生（檔案瀏覽器、工具列）
- Markdown 渲染使用 Blazor WebView + TypeScript（利用豐富的 JS 生態系統）
- 轉換功能使用 C# 套件（QuestPDF、OpenXml）

**預估開發時程**：核心功能（Windows）約 2 週，完整多平台版本約 4-5 週。

---

## 附錄：平台特定實作範例

### Android SAF 整合
```csharp
#if ANDROID
using AndroidX.DocumentFile.Provider;

public class AndroidFileSystemService
{
    public async Task<List<FileNode>> ReadDirectoryAsync(DocumentFile documentFile)
    {
        // 使用 SAF API 讀取檔案
    }
}
#endif
```

### macOS 檔案選擇
```csharp
#if MACCATALYST
using AppKit;

public class MacFileSystemService
{
    public async Task<string> RequestDirectoryAccess()
    {
        var openPanel = new NSOpenPanel
        {
            CanChooseFiles = false,
            CanChooseDirectories = true,
            AllowsMultipleSelection = false
        };
        
        if (openPanel.RunModal() == 1)
        {
            return openPanel.Url.Path;
        }
        
        return null;
    }
}
#endif
```

